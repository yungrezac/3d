<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Taxi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>

    <style>
        /* Custom styles for better look and feel */
        body {
            overscroll-behavior: none;
        }
        .bottom-sheet {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }
        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right {
            display: none; /* Hide default Mapbox controls to avoid clutter */
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen">

    <div id="app" class="h-full w-full relative">
        <!-- Map container -->
        <div id="map" class="absolute inset-0 z-0"></div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-80 backdrop-blur-sm">
            <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg">Загрузка приложения...</p>
        </div>
        
        <!-- Registration Screen -->
        <div id="registration-screen" class="hidden absolute inset-0 z-40 flex items-end justify-center">
            <div class="bg-gray-800 w-full rounded-t-2xl p-6 shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Добро пожаловать!</h2>
                <p class="text-gray-400 mb-6">Пожалуйста, представьтесь, чтобы начать пользоваться сервисом.</p>
                <form id="registration-form">
                    <div class="mb-4">
                        <label for="full_name" class="block text-sm font-medium text-gray-300 mb-1">Ваше имя</label>
                        <input type="text" id="full_name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" required placeholder="Иван Иванов">
                    </div>
                    <div class="mb-6">
                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Номер телефона</label>
                        <input type="tel" id="phone" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" required placeholder="+7 (999) 123-45-67">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                        Зарегистрироваться
                    </button>
                </form>
            </div>
        </div>

        <!-- Main UI container -->
        <div id="main-ui" class="absolute inset-0 z-10 pointer-events-none">
            <!-- Passenger UI -->
            <div id="passenger-ui" class="hidden h-full w-full">
                <div id="passenger-controls" class="bottom-sheet absolute bottom-0 left-0 right-0 h-[35%] bg-gray-800 rounded-t-2xl shadow-2xl p-4 flex flex-col pointer-events-auto">
                    <!-- State: Idle -->
                    <div id="passenger-idle-state" class="">
                        <div class="w-10 h-1.5 bg-gray-600 rounded-full mx-auto mb-3"></div>
                        <h2 class="text-xl font-bold text-center mb-4">Куда поедем?</h2>
                        <div class="relative mb-3">
                            <input id="pickup-location" type="text" placeholder="Откуда" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 pl-10 text-white focus:outline-none" disabled>
                            <i data-lucide="circle-dot" class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400"></i>
                        </div>
                        <div class="relative mb-4">
                             <input id="destination-location" type="text" placeholder="Куда" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 pl-10 text-white focus:outline-none">
                             <i data-lucide="map-pin" class="absolute left-3 top-1/2 -translate-y-1/2 text-red-400"></i>
                        </div>
                        <button id="request-ride-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
                            Заказать такси
                        </button>
                    </div>

                    <!-- State: Requesting -->
                    <div id="passenger-requesting-state" class="hidden text-center">
                        <div class="w-10 h-1.5 bg-gray-600 rounded-full mx-auto mb-3"></div>
                        <h2 class="text-xl font-bold mb-4">Ищем водителя...</h2>
                        <div class="flex justify-center items-center my-4">
                            <svg class="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <button id="cancel-ride-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors mt-4">
                            Отменить заказ
                        </button>
                    </div>

                     <!-- State: On Trip -->
                    <div id="passenger-ontrip-state" class="hidden">
                         <div class="w-10 h-1.5 bg-gray-600 rounded-full mx-auto mb-3"></div>
                         <h2 class="text-xl font-bold mb-3 text-center">Ваш водитель в пути</h2>
                         <div class="bg-gray-700 p-3 rounded-lg flex items-center gap-4">
                            <img id="driver-avatar" src="https://placehold.co/60x60/1F2937/FFFFFF?text=D" class="w-14 h-14 rounded-full object-cover">
                            <div>
                               <p id="driver-name" class="font-bold text-lg">Имя Водителя</p>
                               <div class="flex items-center gap-2 text-gray-300">
                                   <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-current"></i>
                                   <span id="driver-rating">5.0</span>
                               </div>
                            </div>
                            <div class="ml-auto text-right">
                                <p id="driver-car" class="font-semibold">Kia Rio</p>
                                <p id="driver-plate" class="bg-gray-800 px-2 py-1 rounded text-sm font-mono tracking-widest">A123BC777</p>
                            </div>
                         </div>
                         <p class="text-center text-gray-300 mt-4">Примерное время прибытия: <span id="driver-eta" class="font-bold text-white">5 минут</span></p>
                    </div>

                </div>
            </div>

            <!-- Driver UI -->
            <div id="driver-ui" class="hidden h-full w-full">
                 <div id="driver-controls" class="bottom-sheet absolute bottom-0 left-0 right-0 h-[35%] bg-gray-800 rounded-t-2xl shadow-2xl p-4 flex flex-col justify-between pointer-events-auto">
                    <!-- State: Offline -->
                    <div id="driver-offline-state" class="text-center flex flex-col items-center justify-center h-full">
                         <div class="w-10 h-1.5 bg-gray-600 rounded-full -mt-1 mb-3"></div>
                         <h2 class="text-xl font-bold mb-4">Вы не на линии</h2>
                         <p class="text-gray-400 mb-6">Нажмите, чтобы начать принимать заказы.</p>
                         <button id="go-online-btn" class="w-full max-w-xs bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            Выйти на линию
                         </button>
                    </div>
                    
                    <!-- State: Online (waiting for orders) -->
                    <div id="driver-online-state" class="hidden text-center flex flex-col items-center justify-center h-full">
                         <div class="w-10 h-1.5 bg-gray-600 rounded-full -mt-1 mb-3"></div>
                         <h2 class="text-xl font-bold mb-4 text-green-400">Вы на линии</h2>
                         <p class="text-gray-400 mb-6">Ожидание новых заказов...</p>
                         <button id="go-offline-btn" class="w-full max-w-xs bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            Уйти с линии
                         </button>
                    </div>

                    <!-- State: Incoming Request -->
                    <div id="driver-request-state" class="hidden h-full flex flex-col">
                        <div class="w-10 h-1.5 bg-gray-600 rounded-full mx-auto mb-2"></div>
                        <h2 class="text-xl font-bold text-center text-blue-400">Новый заказ!</h2>
                        <div class="bg-gray-700 p-3 rounded-lg my-2 flex-grow">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-gray-400">Подача</p>
                                <p id="request-pickup" class="font-semibold text-right">ул. Пушкина, д. 1</p>
                            </div>
                             <div class="flex justify-between items-center">
                                <p class="text-gray-400">Назначение</p>
                                <p id="request-destination" class="font-semibold text-right">пр. Ленина, д. 20</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button id="decline-ride-btn" class="w-full bg-gray-600 hover:bg-gray-700 font-bold py-3 rounded-lg transition-colors">Отклонить</button>
                            <button id="accept-ride-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 rounded-lg transition-colors">Принять</button>
                        </div>
                    </div>

                    <!-- State: Driver on Trip -->
                    <div id="driver-ontrip-state" class="hidden h-full flex flex-col">
                        <div class="w-10 h-1.5 bg-gray-600 rounded-full mx-auto mb-2"></div>
                        <div id="trip-header" class="text-center">
                           <h2 class="text-xl font-bold text-blue-400">Направляйтесь к клиенту</h2>
                           <p id="trip-address" class="text-gray-300">ул. Пушкина, д. 1</p>
                        </div>
                        <div class="my-4 flex-grow flex items-center justify-center">
                            <!-- Could show passenger info here -->
                            <p class="text-gray-500">Навигация (внешняя)</p>
                        </div>
                        <button id="trip-action-btn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 rounded-lg transition-colors">
                            Я на месте
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://skoobtvzeojdmvjsexdm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrb29idHZ6ZW9qZG12anNleGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTI5MjksImV4cCI6MjA3Mjc4ODkyOX0.3rtdGA9o07WUV8pKZctK4pA6VJyaUjn5MeZR-bigzP8';
        const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';

        // --- GLOBAL STATE ---
        let map;
        let supabase;
        let tg;
        let currentUser = null;
        let currentRide = null;
        let userMarker;
        let rideSubscription = null;
        let rideRequestSubscription = null;
        
        // --- UI ELEMENTS ---
        const ui = {
            loadingScreen: document.getElementById('loading-screen'),
            registrationScreen: document.getElementById('registration-screen'),
            registrationForm: document.getElementById('registration-form'),
            passengerUI: document.getElementById('passenger-ui'),
            passengerControls: document.getElementById('passenger-controls'),
            passengerIdle: document.getElementById('passenger-idle-state'),
            passengerRequesting: document.getElementById('passenger-requesting-state'),
            passengerOnTrip: document.getElementById('passenger-ontrip-state'),
            driverUI: document.getElementById('driver-ui'),
            driverControls: document.getElementById('driver-controls'),
            driverOffline: document.getElementById('driver-offline-state'),
            driverOnline: document.getElementById('driver-online-state'),
            driverRequest: document.getElementById('driver-request-state'),
            driverOnTrip: document.getElementById('driver-ontrip-state'),
            pickupLocationInput: document.getElementById('pickup-location'),
            requestRideBtn: document.getElementById('request-ride-btn'),
            cancelRideBtn: document.getElementById('cancel-ride-btn'),
            goOnlineBtn: document.getElementById('go-online-btn'),
            goOfflineBtn: document.getElementById('go-offline-btn'),
            acceptRideBtn: document.getElementById('accept-ride-btn'),
            declineRideBtn: document.getElementById('decline-ride-btn'),
            tripActionBtn: document.getElementById('trip-action-btn'),
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', main);

        async function main() {
            lucide.createIcons();
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();

            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            initializeMap();
            await authenticateUser();
        }

        function initializeMap() {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [37.6173, 55.7558], // Default to Moscow
                zoom: 12
            });

            map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');

            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.flyTo({ center: [longitude, latitude], zoom: 15 });
                ui.pickupLocationInput.value = "Ваше текущее местоположение";

                if (userMarker) userMarker.remove();
                userMarker = new mapboxgl.Marker({ color: '#3B82F6' })
                    .setLngLat([longitude, latitude])
                    .addTo(map);

            }, (err) => {
                console.warn(`ERROR(${err.code}): ${err.message}`);
                // Handle error - maybe show a message to the user
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }

        // --- AUTH & USER LOGIC ---
        async function authenticateUser() {
            showScreen('loading');
            try {
                // For testing in browser, use a mock user
                const telegramUser = tg.initDataUnsafe?.user || { id: 123456789, first_name: "Test", last_name: "User" };

                if (!telegramUser) {
                    throw new Error("Не удалось получить данные пользователя Telegram.");
                }

                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('telegram_id', telegramUser.id)
                    .single();

                if (error && error.code === 'PGRST116') { // User not found
                    showScreen('registration');
                    ui.registrationForm.querySelector('#full_name').value = `${telegramUser.first_name || ''} ${telegramUser.last_name || ''}`.trim();
                } else if (data) {
                    currentUser = data;
                    console.log('User authenticated:', currentUser);
                    loadRoleUI(currentUser.role);
                } else {
                    throw error || new Error("Произошла неизвестная ошибка аутентификации.");
                }

            } catch (err) {
                console.error("Auth Error:", err);
                tg.showAlert(`Ошибка аутентификации: ${err.message}`);
            } finally {
                if (currentUser) {
                     ui.loadingScreen.classList.add('hidden');
                }
            }
        }

        ui.registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = ui.registrationForm.querySelector('#full_name').value;
            const phone = ui.registrationForm.querySelector('#phone').value;
            const telegramUser = tg.initDataUnsafe?.user || { id: 123456789 };

            const { data, error } = await supabase
                .from('user_profiles')
                .insert({
                    id: crypto.randomUUID(), // Assuming `id` is not auto-generated by auth trigger
                    full_name: fullName,
                    phone: phone,
                    telegram_id: telegramUser.id
                })
                .select()
                .single();

            if (error) {
                console.error('Registration error:', error);
                tg.showAlert(`Ошибка регистрации: ${error.message}`);
            } else {
                currentUser = data;
                console.log('User registered:', currentUser);
                await authenticateUser(); // Re-auth to load the correct UI
            }
        });

        // --- UI & ROLE MANAGEMENT ---
        function showScreen(screen) {
            ['loading', 'registration'].forEach(s => {
                const el = document.getElementById(`${s}-screen`);
                if (s === screen) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }
        
        function setPassengerState(state) {
            ['idle', 'requesting', 'ontrip'].forEach(s => {
                const el = document.getElementById(`passenger-${s}-state`);
                if(s === state) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }
        
        function setDriverState(state) {
            ['offline', 'online', 'request', 'ontrip'].forEach(s => {
                const el = document.getElementById(`driver-${s}-state`);
                if(s === state) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function loadRoleUI(role) {
            if (role === 'passenger') {
                ui.passengerUI.classList.remove('hidden');
                ui.driverUI.classList.add('hidden');
                ui.passengerControls.classList.add('active');
                setPassengerState('idle');
                setupPassengerListeners();
            } else if (role === 'driver') {
                ui.driverUI.classList.remove('hidden');
                ui.passengerUI.classList.add('hidden');
                ui.driverControls.classList.add('active');
                setDriverState('offline');
                setupDriverListeners();
            }
        }

        // --- PASSENGER LOGIC ---
        function setupPassengerListeners() {
            ui.requestRideBtn.onclick = requestRide;
            ui.cancelRideBtn.onclick = cancelRide;
        }
        
        async function requestRide() {
            const destination = document.getElementById('destination-location').value;
            if (!destination) {
                tg.showAlert('Пожалуйста, укажите пункт назначения.');
                return;
            }
            
            setPassengerState('requesting');
            const userCoords = userMarker.getLngLat();

            const { data, error } = await supabase
                .from('rides')
                .insert({
                    passenger_id: currentUser.id,
                    pickup_location: 'Текущее местоположение',
                    pickup_latitude: userCoords.lat,
                    pickup_longitude: userCoords.lng,
                    destination_location: destination,
                    // destination coordinates would be resolved by a geocoder in a real app
                })
                .select()
                .single();
                
            if (error) {
                console.error("Ride request error:", error);
                tg.showAlert("Не удалось создать заказ.");
                setPassengerState('idle');
            } else {
                currentRide = data;
                listenToRideUpdates(currentRide.id);
            }
        }

        async function cancelRide() {
            if (!currentRide) return;
            
            const { error } = await supabase
                .from('rides')
                .update({ ride_status: 'cancelled', cancelled_at: new Date().toISOString() })
                .eq('id', currentRide.id);

            if (error) {
                 tg.showAlert("Не удалось отменить заказ.");
            } else {
                 if (rideSubscription) rideSubscription.unsubscribe();
                 currentRide = null;
                 setPassengerState('idle');
                 tg.HapticFeedback.notificationOccurred('warning');
            }
        }
        
        function listenToRideUpdates(rideId) {
            if (rideSubscription) rideSubscription.unsubscribe();

            rideSubscription = supabase
                .channel(`public:rides:id=eq.${rideId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rides', filter: `id=eq.${rideId}` }, async (payload) => {
                    console.log('Ride update received:', payload);
                    currentRide = payload.new;
                    
                    if (currentRide.ride_status === 'accepted') {
                        setPassengerState('ontrip');
                        tg.HapticFeedback.notificationOccurred('success');
                        
                        // Fetch driver info
                        const {data: driverData} = await supabase
                            .from('user_profiles')
                            .select('full_name, avatar_url, rating')
                            .eq('id', currentRide.driver_id)
                            .single();
                        
                        const {data: vehicleData} = await supabase
                            .from('vehicles')
                            .select('brand, model, plate_number')
                            .eq('driver_id', currentRide.driver_id)
                            .single();
                        
                        if(driverData) {
                            document.getElementById('driver-name').innerText = driverData.full_name;
                            document.getElementById('driver-rating').innerText = driverData.rating.toFixed(1);
                            if(driverData.avatar_url) document.getElementById('driver-avatar').src = driverData.avatar_url;
                        }
                        if(vehicleData){
                            document.getElementById('driver-car').innerText = `${vehicleData.brand} ${vehicleData.model}`;
                            document.getElementById('driver-plate').innerText = vehicleData.plate_number;
                        }
                    } else if (currentRide.ride_status === 'completed' || currentRide.ride_status === 'cancelled') {
                        if (rideSubscription) rideSubscription.unsubscribe();
                        setPassengerState('idle');
                        // Here you would show a rating screen
                    }
                })
                .subscribe();
        }

        // --- DRIVER LOGIC ---
        function setupDriverListeners() {
            ui.goOnlineBtn.onclick = () => toggleDriverStatus(true);
            ui.goOfflineBtn.onclick = () => toggleDriverStatus(false);
            ui.acceptRideBtn.onclick = acceptRide;
            ui.declineRideBtn.onclick = declineRide;
            ui.tripActionBtn.onclick = handleTripAction;
        }

        function toggleDriverStatus(isOnline) {
            if (isOnline) {
                setDriverState('online');
                listenForRideRequests();
                tg.HapticFeedback.impactOccurred('light');
            } else {
                setDriverState('offline');
                if (rideRequestSubscription) rideRequestSubscription.unsubscribe();
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        function listenForRideRequests() {
            if (rideRequestSubscription) rideRequestSubscription.unsubscribe();

            rideRequestSubscription = supabase
                .channel('public:rides')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'rides', filter: 'ride_status=eq.requesting' }, (payload) => {
                    console.log('New ride request:', payload.new);
                    currentRide = payload.new;
                    document.getElementById('request-pickup').innerText = currentRide.pickup_location;
                    document.getElementById('request-destination').innerText = currentRide.destination_location;
                    setDriverState('request');
                    tg.HapticFeedback.notificationOccurred('success');
                })
                .subscribe();
        }
        
        async function acceptRide() {
            if (!currentRide) return;

            const { error } = await supabase
                .from('rides')
                .update({
                    driver_id: currentUser.id,
                    ride_status: 'accepted',
                    accepted_at: new Date().toISOString()
                })
                .eq('id', currentRide.id);

            if (error) {
                tg.showAlert("Не удалось принять заказ.");
            } else {
                if (rideRequestSubscription) rideRequestSubscription.unsubscribe(); // Stop listening for other requests
                document.getElementById('trip-address').innerText = currentRide.pickup_location;
                setDriverState('ontrip');
            }
        }
        
        function declineRide() {
            currentRide = null;
            setDriverState('online'); // Go back to waiting for orders
        }

        async function handleTripAction() {
            // This function would handle "I'm here", "Start trip", "End trip" logic
            const button = ui.tripActionBtn;
            let newStatus;
            let newHeaderText;
            let newButtonText;
            
            switch(currentRide.ride_status) {
                case 'accepted':
                    newStatus = 'started';
                    newHeaderText = `Везем клиента в ${currentRide.destination_location}`;
                    newButtonText = "Завершить поездку";
                    break;
                case 'started':
                    newStatus = 'completed';
                    break;
            }

            if(newStatus === 'completed') {
                await supabase.from('rides').update({ 
                    ride_status: 'completed', 
                    completed_at: new Date().toISOString()
                }).eq('id', currentRide.id);
                currentRide = null;
                toggleDriverStatus(true); // Go back online
            } else {
                const { data, error } = await supabase.from('rides').update({ 
                    ride_status: newStatus,
                    started_at: new Date().toISOString()
                }).eq('id', currentRide.id).select().single();

                if(error) {
                    tg.showAlert("Не удалось обновить статус поездки");
                } else {
                    currentRide = data;
                    document.getElementById('trip-header').firstElementChild.innerText = newHeaderText;
                    button.innerText = newButtonText;
                }
            }
        }

    </script>
</body>
</html>
