<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Devtol 3D</title>
    <style>
        /* Убираем отступы и скроллбары, делаем фон прозрачным */
        body {
            margin: 0;
            overflow: hidden;
            background-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: var(--tg-theme-text-color, #000000); /* Используем цвет текста из темы Telegram */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        /* Стили для кнопки запроса разрешений на iOS */
        #permissionButton {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-button-text-color, #ffffff);
            background-color: var(--tg-theme-button-color, #007bff);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #permissionButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        #permissionButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        /* Канвас для 3D сцены */
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Кнопка для запроса доступа к акселерометру (необходима для iOS) -->
    <button id="permissionButton">Включить акселерометр</button>

    <!-- Подключение SDK Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключение библиотеки Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready(); // Сообщаем Telegram, что приложение готово

            // Устанавливаем цвет фона в соответствии с темой Telegram
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';

            let scene, camera, renderer, textMesh;
            let targetRotation = { x: 0, y: 0 };

            const permissionButton = document.getElementById('permissionButton');

            // Функция для инициализации 3D сцены
            function init() {
                // 1. Сцена
                scene = new THREE.Scene();

                // 2. Камера
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 15;

                // 3. Рендерер
                renderer = new THREE.WebGLRenderer({
                    alpha: true, // Включаем прозрачность
                    antialias: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                // Делаем рендерер прозрачным, чтобы был виден фон из темы
                renderer.setClearColor(0x000000, 0);
                document.body.appendChild(renderer.domElement);

                // 4. Освещение
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 0.8);
                pointLight.position.set(5, 10, 15);
                scene.add(pointLight);

                // 5. Загрузка шрифта и создание текста
                const fontLoader = new THREE.FontLoader();
                // Используем стандартный шрифт Helvetiker, доступный по CDN
                fontLoader.load('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/fonts/helvetiker_bold.typeface.json', (font) => {
                    const textGeometry = new THREE.TextGeometry('devtol скоро', {
                        font: font,
                        size: 2,
                        height: 0.5,
                        curveSegments: 12,
                        bevelEnabled: true,
                        bevelThickness: 0.03,
                        bevelSize: 0.05,
                        bevelOffset: 0,
                        bevelSegments: 5
                    });
                    
                    // Центрируем геометрию текста
                    textGeometry.computeBoundingBox();
                    const textWidth = textGeometry.boundingBox.max.x - textGeometry.boundingBox.min.x;
                    textGeometry.translate(-textWidth / 2, 0, 0);

                    // Создаем материал, который красиво отражает свет
                    const textMaterial = new THREE.MeshStandardMaterial({
                        color: tg.themeParams.button_color || 0x007bff, // Цвет текста как цвет кнопки в Telegram
                        metalness: 0.7,
                        roughness: 0.3
                    });

                    textMesh = new THREE.Mesh(textGeometry, textMaterial);
                    scene.add(textMesh);
                });

                // 6. Запускаем цикл анимации
                animate();
            }

            // Функция для обработки данных с акселерометра
            function handleOrientation(event) {
                // event.beta: наклон вперед-назад (-180 до 180)
                // event.gamma: наклон влево-вправо (-90 до 90)
                const beta = event.beta;  // Наклон по оси X
                const gamma = event.gamma; // Наклон по оси Y

                // Устанавливаем целевой угол поворота, конвертируя градусы в радианы
                // Ограничиваем угол, чтобы текст не переворачивался слишком сильно
                targetRotation.x = THREE.MathUtils.degToRad(Math.max(-45, Math.min(45, beta)));
                targetRotation.y = THREE.MathUtils.degToRad(Math.max(-45, Math.min(45, gamma)));
            }
            
            // Цикл анимации для плавного рендеринга
            function animate() {
                requestAnimationFrame(animate);

                // Плавно интерполируем текущий поворот к целевому
                if (textMesh) {
                    textMesh.rotation.x += (targetRotation.x - textMesh.rotation.x) * 0.05;
                    textMesh.rotation.y += (targetRotation.y - textMesh.rotation.y) * 0.05;
                }

                renderer.render(scene, camera);
            }

            // Обработка изменения размера окна
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Запрос разрешений для iOS 13+
            function requestDeviceOrientation() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                permissionButton.style.display = 'none'; // Скрываем кнопку
                                init(); // Инициализируем сцену после получения разрешения
                            } else {
                                alert('Доступ к акселерометру отклонен. Функциональность будет ограничена.');
                                permissionButton.style.display = 'none';
                                init();
                            }
                        })
                        .catch(console.error);
                } else {
                    // Для Android и других устройств, где разрешение не требуется
                    window.addEventListener('deviceorientation', handleOrientation);
                    permissionButton.style.display = 'none';
                    init();
                }
            }

            permissionButton.addEventListener('click', requestDeviceOrientation);
            
            // Если разрешение не требуется, кнопка скроется и приложение запустится сразу
            if (typeof DeviceOrientationEvent === 'undefined' || typeof DeviceOrientationEvent.requestPermission !== 'function') {
                 requestDeviceOrientation();
            }
        });
    </script>
</body>
</html>
