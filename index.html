<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Такси Mini App</title>
    
    <!-- Скрипт Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Стили и скрипт Mapbox GL JS для карты -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    
    <!-- Скрипт для иконок Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Скрипт Telegram Web App для интеграции с Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Клиент Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body, html {
            overscroll-behavior: none;
            overflow: hidden;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        .bottom-sheet {
            touch-action: none;
            transition: transform 0.3s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="global-loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50 p-4">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-gray-600">Подключаемся...</p>
    </div>

    <div id="app-container" class="relative h-screen w-screen hidden">
        <div id="map" class="absolute inset-0"></div>

        <!-- EKRAN PASSAZHIRA -->
        <div id="passenger-screen" class="hidden">
            <div id="bottom-sheet" class="bottom-sheet absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl p-4 flex flex-col z-10" style="transform: translateY(calc(100% - 280px));">
                <div id="sheet-handle" class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab active:cursor-grabbing"></div>
                <div id="sheet-content">
                    <div id="order-form-state">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Куда поедем?</h2>
                        <div class="space-y-3">
                            <div class="relative flex items-center">
                                <i data-lucide="circle" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                                <input id="from-input" type="text" placeholder="Откуда" class="w-full bg-gray-100 border-transparent rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="relative flex items-center">
                                <i data-lucide="map-pin" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                                <input id="to-input" type="text" placeholder="Куда" class="w-full bg-gray-100 border-transparent rounded-lg pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button id="order-button" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-lg mt-5 hover:bg-blue-700 active:bg-blue-800 transition-colors">Заказать такси</button>
                    </div>
                    <div id="searching-state" class="hidden text-center py-8">
                        <div class="loader mx-auto"></div>
                        <h3 class="text-xl font-semibold mt-4">Ищем машину...</h3>
                        <button id="cancel-search-button" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-lg mt-6 hover:bg-red-700">Отменить поиск</button>
                    </div>
                    <div id="driver-found-state" class="hidden">
                         <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Водитель найден!</h2>
                         <p id="driver-arrival-time" class="text-center text-gray-500 mb-4">Машина будет через 5 минут</p>
                         <div class="bg-gray-100 p-3 rounded-lg flex items-center space-x-4">
                             <img id="driver-avatar" src="https://placehold.co/60x60/E2E8F0/A0AEC0?text=A" class="w-14 h-14 rounded-full" alt="Driver Avatar">
                             <div>
                                 <p id="driver-name" class="font-bold text-lg">Водитель</p>
                                 <p id="driver-car" class="text-gray-600">Машина</p>
                             </div>
                             <div class="flex-grow text-right"><p id="driver-car-plate" class="font-mono bg-white border border-gray-300 px-2 py-1 rounded">A123BC</p></div>
                         </div>
                         <div class="mt-4 text-center"><p id="ride-status-passenger" class="text-lg font-medium text-blue-600">Водитель едет к вам</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EKRAN VODITELYA -->
        <div id="driver-screen" class="hidden w-full h-full flex flex-col p-4 bg-white z-20 absolute inset-0">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Заказы</h1>
                <div class="flex items-center space-x-2">
                    <span id="driver-status-text" class="text-gray-600 font-medium">Офлайн</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="driver-status-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            <div id="active-ride-driver" class="hidden border-2 border-blue-500 rounded-lg p-4 mb-4">
                <h2 class="text-xl font-bold mb-2">Активный заказ</h2>
                 <div class="space-y-2">
                    <p><strong>Откуда:</strong> <span id="active-ride-from"></span></p>
                    <p><strong>Куда:</strong> <span id="active-ride-to"></span></p>
                    <p><strong>Стоимость:</strong> <span id="active-ride-fare" class="font-bold"></span> руб.</p>
                </div>
                <div id="driver-action-buttons" class="mt-4 space-y-2"></div>
            </div>
            <h2 id="available-orders-title" class="text-xl font-bold mb-2">Доступные заказы</h2>
            <div id="orders-list" class="flex-grow overflow-y-auto space-y-3 pb-4">
                <div id="no-orders-placeholder" class="text-center py-10 text-gray-500">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto"></i>
                    <p class="mt-2">Нет доступных заказов</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS AND GLOBAL VARIABLES ---
            const SUPABASE_URL = 'https://skoobtvzeojdmvjsexdm.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIJWTJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrb29idHZ6ZW9qZG12anNleGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTI5MjksImV4cCI6MjA3Mjc4ODkyOX0.3rtdGA9o07WUV8pKZctK4pA6VJyaUjn5MeZR-bigzP8';
            
            const globalLoader = document.getElementById('global-loader');
            const appContainer = document.getElementById('app-container');
            const loaderText = document.getElementById('loader-text');
            
            // CORRECTED: Use a separate variable for the client instance
            let supabaseClient = null;
            let currentUser = null;
            let map = null;
            let realtimeChannel = null;
            let currentRideId = null;

            // --- MAIN INITIALIZATION FUNCTION ---
            async function main() {
                try {
                    console.log("Application starting...");
                    
                    if (typeof window.Telegram === 'undefined' || typeof window.Telegram.WebApp === 'undefined') {
                        showError("Ошибка: Приложение должно быть запущено внутри Telegram.", true);
                        return;
                    }
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    console.log("Telegram environment is ready.");

                    // CORRECTED: Correctly initialize the Supabase client
                    // 'supabase' here is the global object from the script tag
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    if (!supabaseClient) {
                         showError("Не удалось инициализировать клиент Supabase.", true);
                         return;
                    }
                    console.log("Supabase client initialized successfully.");

                    loaderText.textContent = "Авторизация...";
                    const tgUser = tg.initDataUnsafe.user;
                    if (!tgUser) {
                        showError("Не удалось получить данные пользователя Telegram.", true);
                        return;
                    }
                    console.log("Got Telegram user data:", tgUser);

                    currentUser = await getOrCreateUser(tgUser);
                    if (!currentUser) return; // Error is shown inside the function
                    console.log("Database user profile:", currentUser);

                    loaderText.textContent = "Загрузка карты...";
                    initializeMap();
                    console.log("Map initialized.");

                    if (currentUser.role === 'driver') {
                        await setupDriverScreen();
                    } else {
                        await setupPassengerScreen();
                    }

                    globalLoader.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    lucide.createIcons();
                    console.log("Application initialized successfully.");

                } catch (error) {
                    console.error("Критическая ошибка при инициализации:", error);
                    showError(`Критическая ошибка: ${error.message}`, true);
                }
            }

            // --- USER FUNCTIONS ---
            async function getOrCreateUser(tgUser) {
                try {
                    let { data: user, error } = await supabaseClient
                        .from('user_profiles')
                        .select('*')
                        .eq('telegram_id', tgUser.id)
                        .single();

                    if (error && error.code !== 'PGRST116') throw error;

                    if (!user) {
                        const fullName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim();
                        const { data: newUser, error: insertError } = await supabaseClient
                            .from('user_profiles')
                            .insert({
                                id: crypto.randomUUID(),
                                telegram_id: tgUser.id,
                                full_name: fullName || tgUser.username || `User ${tgUser.id}`,
                                role: 'passenger'
                            })
                            .select()
                            .single();
                        
                        if (insertError) throw insertError;
                        return newUser;
                    }
                    return user;
                } catch (error) {
                    console.error('Ошибка при поиске или создании пользователя:', error);
                    showError("Ошибка при авторизации в базе данных.");
                    return null;
                }
            }
            
            function initializeMap() {
                mapboxgl.accessToken = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [37.6173, 55.7558], zoom: 11, attributionControl: false
                });
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            }

            // --- PASSENGER SCREEN LOGIC ---
            async function setupPassengerScreen() {
                document.getElementById('passenger-screen').classList.remove('hidden');
                
                const orderButton = document.getElementById('order-button');
                const cancelSearchButton = document.getElementById('cancel-search-button');
                const fromInput = document.getElementById('from-input');
                const toInput = document.getElementById('to-input');

                setupBottomSheet(document.getElementById('bottom-sheet'), document.getElementById('sheet-handle'));

                orderButton.addEventListener('click', async () => {
                    if (!fromInput.value || !toInput.value) {
                        window.Telegram.WebApp.showAlert("Пожалуйста, укажите адреса 'Откуда' и 'Куда'.");
                        return;
                    }
                    switchPassengerState('searching-state');
                    try {
                        const { data: ride, error } = await supabaseClient
                            .from('rides').insert({
                                passenger_id: currentUser.id,
                                pickup_location: fromInput.value,
                                destination_location: toInput.value,
                                ride_status: 'requesting',
                                fare_amount: Math.floor(Math.random() * (1000 - 300 + 1)) + 300
                            }).select().single();
                        if (error) throw error;
                        currentRideId = ride.id;
                        subscribeToRideUpdates(ride.id);
                    } catch (error) {
                        window.Telegram.WebApp.showAlert("Не удалось создать заказ. Попробуйте еще раз.");
                        switchPassengerState('order-form-state');
                    }
                });
                
                cancelSearchButton.addEventListener('click', async () => {
                   if (!currentRideId) return;
                   await supabaseClient.from('rides').update({ ride_status: 'cancelled' }).eq('id', currentRideId);
                   if(realtimeChannel) realtimeChannel.unsubscribe();
                   switchPassengerState('order-form-state');
                   window.Telegram.WebApp.showPopup({ title: 'Отменено', message: 'Заказ был отменен.' });
                   currentRideId = null;
                });
            }

            function switchPassengerState(state) {
                ['order-form-state', 'searching-state', 'driver-found-state'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                const element = document.getElementById(state);
                if(element) element.classList.remove('hidden');
            }
            
            function subscribeToRideUpdates(rideId) {
                if (realtimeChannel) realtimeChannel.unsubscribe();
                realtimeChannel = supabaseClient.channel(`ride-${rideId}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rides', filter: `id=eq.${rideId}` }, payload => {
                        updatePassengerRideStatus(payload.new);
                    }).subscribe();
            }

            async function updatePassengerRideStatus(ride) {
                const status = ride.ride_status;
                if (['accepted', 'enroute', 'in_progress'].includes(status)) {
                    switchPassengerState('driver-found-state');
                    const { data: driver } = await supabaseClient.from('user_profiles').select('full_name').eq('id', ride.driver_id).single();
                    const { data: vehicle } = await supabaseClient.from('vehicles').select('brand, model, color, plate_number').eq('driver_id', ride.driver_id).single();
                    document.getElementById('driver-name').textContent = driver?.full_name || 'Неизвестно';
                    document.getElementById('driver-car').textContent = vehicle ? `${vehicle.color} ${vehicle.brand} ${vehicle.model}` : 'Машина';
                    document.getElementById('driver-car-plate').textContent = vehicle?.plate_number || '...';
                    const statusText = {'accepted': 'Водитель принял заказ', 'enroute': 'Водитель едет к вам', 'in_progress': 'В пути'};
                    document.getElementById('ride-status-passenger').textContent = statusText[status] || 'В пути';
                }

                if (status === 'completed' || status === 'cancelled') {
                    if(realtimeChannel) realtimeChannel.unsubscribe();
                    const title = status === 'completed' ? 'Поездка завершена!' : 'Поездка отменена';
                    const message = status === 'completed' ? 'Спасибо, что выбрали нас!' : 'Ваш заказ был отменен.';
                    window.Telegram.WebApp.showPopup({ title, message, buttons: [{ type: 'ok' }]});
                    switchPassengerState('order-form-state');
                    currentRideId = null;
                }
            }

            // --- DRIVER SCREEN LOGIC ---
            async function setupDriverScreen() {
                document.getElementById('driver-screen').classList.remove('hidden');
                document.getElementById('map').classList.add('hidden');
                const statusToggle = document.getElementById('driver-status-toggle');
                const statusText = document.getElementById('driver-status-text');

                statusToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        statusText.textContent = 'На линии';
                        statusText.classList.add('text-green-600');
                        subscribeToRides();
                    } else {
                        statusText.textContent = 'Офлайн';
                        statusText.classList.remove('text-green-600');
                        if (realtimeChannel) realtimeChannel.unsubscribe();
                        document.getElementById('orders-list').innerHTML = '';
                        document.getElementById('no-orders-placeholder').classList.remove('hidden');
                    }
                });
                await checkActiveRide();
            }

            function subscribeToRides() {
                renderAvailableRides();
                if (realtimeChannel) realtimeChannel.unsubscribe();
                realtimeChannel = supabaseClient.channel('public:rides')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, () => {
                    checkActiveRide();
                    renderAvailableRides();
                  }).subscribe();
            }

            async function renderAvailableRides() {
                const { data: rides, error } = await supabaseClient.from('rides').select('*').eq('ride_status', 'requesting');
                if (error) return;
                const ordersList = document.getElementById('orders-list');
                const placeholder = document.getElementById('no-orders-placeholder');
                ordersList.innerHTML = '';
                placeholder.classList.toggle('hidden', rides.length > 0);

                rides.forEach(ride => {
                    ordersList.insertAdjacentHTML('beforeend', `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold">${ride.pickup_location}</p>
                                <div class="text-lg font-bold text-blue-600 pl-4">${ride.fare_amount} ₽</div>
                            </div>
                            <p class="text-sm text-gray-500">${ride.destination_location}</p>
                            <button data-ride-id="${ride.id}" class="accept-ride-btn mt-4 w-full bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600">Принять заказ</button>
                        </div>`);
                });
                document.querySelectorAll('.accept-ride-btn').forEach(b => b.onclick = acceptRide);
            }
            
            async function acceptRide(event) {
                event.target.disabled = true;
                event.target.textContent = 'Принимаем...';
                const { error } = await supabaseClient.from('rides').update({ driver_id: currentUser.id, ride_status: 'accepted' })
                    .eq('id', event.target.dataset.rideId).eq('ride_status', 'requesting');
                if (error) {
                    window.Telegram.WebApp.showAlert('Не удалось принять заказ. Возможно, его уже кто-то взял.');
                    event.target.disabled = false;
                    event.target.textContent = 'Принять заказ';
                }
            }
            
            async function checkActiveRide() {
                const { data: ride } = await supabaseClient.from('rides').select('*').eq('driver_id', currentUser.id).in('ride_status', ['accepted', 'enroute', 'in_progress']).maybeSingle();
                const activeRideContainer = document.getElementById('active-ride-driver');
                const isRideActive = !!ride;

                document.getElementById('available-orders-title').classList.toggle('hidden', isRideActive);
                document.getElementById('orders-list').classList.toggle('hidden', isRideActive);
                activeRideContainer.classList.toggle('hidden', !isRideActive);

                if (isRideActive) {
                    document.getElementById('active-ride-from').textContent = ride.pickup_location;
                    document.getElementById('active-ride-to').textContent = ride.destination_location;
                    document.getElementById('active-ride-fare').textContent = ride.fare_amount;
                    renderDriverActionButtons(ride);
                }
            }
            
            function renderDriverActionButtons(ride) {
                const container = document.getElementById('driver-action-buttons');
                container.innerHTML = '';
                const updateStatus = (newStatus) => supabaseClient.from('rides').update({ ride_status: newStatus }).eq('id', ride.id);
                const actions = {
                    'accepted': { text: 'Я на месте', action: () => updateStatus('enroute'), class: 'bg-blue-500' },
                    'enroute': { text: 'Начать поездку', action: () => updateStatus('in_progress'), class: 'bg-blue-500' },
                    'in_progress': { text: 'Завершить поездку', action: () => updateStatus('completed'), class: 'bg-green-500' }
                };
                if (actions[ride.ride_status]) {
                    const { text, action, 'class': btnClass } = actions[ride.ride_status];
                    container.innerHTML = `<button class="w-full text-white font-bold py-2 rounded-lg ${btnClass}">${text}</button>`;
                    container.firstChild.onclick = action;
                }
                container.innerHTML += `<button class="w-full bg-red-500 text-white font-bold py-2 rounded-lg mt-2">Отменить заказ</button>`;
                container.lastChild.onclick = () => updateStatus('cancelled');
            }
            
            // --- UTILITIES ---
            function showError(message, hideLoaderIcon = false) {
                loaderText.innerHTML = `<span class="text-red-600 font-semibold text-center">${message}</span>`;
                if(hideLoaderIcon) document.querySelector('#global-loader .loader').style.display = 'none';
            }

            function setupBottomSheet(sheet, handle) {
                handle.addEventListener('click', () => {
                    const isOpen = sheet.style.transform.includes('20px');
                    sheet.style.transform = `translateY(${isOpen ? 'calc(100% - 280px)' : '20px'})`;
                });
            }
            
            // --- START THE APP ---
            main();
        });
    </script>
</body>
</html>

