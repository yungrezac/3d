<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Такси Козьмодемьянск</title>
    
    <!-- Подключение зависимостей -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Шрифты -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* CSS переменные для темизации из Telegram */
        :root {
            --tg-bg-color: #ffffff;
            --tg-text-color: #000000;
            --tg-hint-color: #999999;
            --tg-button-color: #2481cc;
            --tg-button-text-color: #ffffff;
            --tg-secondary-bg-color: #f4f4f4;
            --tg-accent-color: #2481cc;
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Отключаем "оттягивание" страницы */
            overflow: hidden;
            height: 100vh; width: 100vw;
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
        }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* Кастомизация маркеров */
        .user-marker {
            width: 20px; height: 20px; background-color: var(--tg-accent-color);
            border: 3px solid var(--tg-bg-color); border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        .driver-marker {
            width: 40px; height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>');
            background-size: 60%; background-position: center; background-repeat: no-repeat;
            background-color: #2a2a2a; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s linear;
        }

        /* Кастомизация геокодера Mapbox */
        .mapboxgl-ctrl-geocoder, .mapboxgl-ctrl-geocoder--input {
            background-color: var(--tg-secondary-bg-color) !important;
            color: var(--tg-text-color) !important;
        }
        .mapboxgl-ctrl-geocoder {
            width: 100% !important; max-width: none !important; font-size: 1rem !important;
            box-shadow: none !important; border-radius: 0.75rem !important;
        }
        .mapboxgl-ctrl-geocoder--input { height: 50px !important; padding-left: 40px !important; }
        .mapboxgl-ctrl-geocoder--icon-search { top: 13px !important; left: 10px !important; }
        .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right > * { top: 15px !important; right: 10px !important; }
        .mapboxgl-ctrl-geocoder--logo { display: none !important; }
        
        /* Спиннер загрузки */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%;
            border-top: 4px solid var(--tg-text-color); width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Стили для модальных окон */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0; transition: opacity 0.3s ease-in-out;
            pointer-events: none; z-index: 40;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            position: fixed; bottom: 0; left: 0; right: 0;
            max-height: 85vh; background: var(--tg-bg-color); color: var(--tg-text-color);
            border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem;
            transform: translateY(100%); transition: transform 0.3s ease-in-out;
            z-index: 50; padding: 1.5rem; overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
        }
        .modal-content.active { transform: translateY(0); }

        /* Звезды рейтинга */
        .rating-star { cursor: pointer; transition: color 0.2s; }
        .rating-star:hover, .rating-star.selected { color: #fbbf24; }
    </style>
</head>
<body class="antialiased">

    <div id="map"></div>

    <!-- Кнопки управления на карте -->
    <div id="map-controls" class="absolute top-4 left-4 right-4 flex justify-between items-center z-10">
        <button id="profile-btn" class="rounded-full p-3 shadow-lg cursor-pointer flex items-center justify-center h-12 w-12" style="background-color: var(--tg-bg-color);">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--tg-text-color);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </button>
        <button id="history-btn" class="rounded-full p-3 shadow-lg cursor-pointer flex items-center justify-center h-12 w-12" style="background-color: var(--tg-bg-color);">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--tg-text-color);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </button>
    </div>

    <!-- Нижняя панель (Bottom Sheet) -->
    <div id="bottom-sheet" class="fixed bottom-0 left-0 right-0 rounded-t-2xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.2)] p-4 transform translate-y-0 transition-transform duration-300 ease-in-out z-20" style="background-color: var(--tg-bg-color);">
        <div class="w-12 h-1.5 rounded-full mx-auto mb-3" style="background-color: var(--tg-hint-color); opacity: 0.3;"></div>

        <!-- Состояние 1: Выбор адреса и тарифа -->
        <div id="address-selection-state" class="pb-16 space-y-4">
            <div class="space-y-3">
                <div class="flex items-center p-3 rounded-xl" style="background-color: var(--tg-secondary-bg-color);">
                    <svg class="w-6 h-6 mr-3 flex-shrink-0 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                    <span class="font-medium w-full truncate" id="from-address" style="color: var(--tg-text-color);">Определение местоположения...</span>
                </div>
                <div id="geocoder-container"></div>
            </div>
            <div id="trip-info" class="mt-2 p-3 rounded-xl hidden flex justify-between items-center" style="background-color: var(--tg-secondary-bg-color);">
                 <div>
                    <p id="estimated-time-distance" class="font-semibold" style="color: var(--tg-text-color);"></p>
                 </div>
                 <p id="estimated-price" class="text-xl font-bold" style="color: var(--tg-text-color);"></p>
            </div>
             <!-- Выбор тарифа -->
            <div id="tariff-selection" class="flex justify-around pt-2"></div>
        </div>

        <!-- Состояние 2: Поиск водителя -->
        <div id="searching-state" class="hidden text-center py-4 pb-16">
            <div class="flex items-center justify-center">
                <div class="spinner mr-4"></div>
                <p class="text-lg font-semibold" style="color: var(--tg-text-color);">Ищем водителя...</p>
            </div>
            <p class="mt-1" style="color: var(--tg-hint-color);">Это может занять до минуты</p>
        </div>

        <!-- Состояние 3: Водитель в пути / Поездка -->
        <div id="trip-state" class="hidden pb-16">
             <div class="flex items-center justify-between">
                <div>
                    <p id="trip-status-text" class="text-xl font-bold" style="color: var(--tg-text-color);">Водитель подъезжает</p>
                    <p id="driver-eta" class="text-lg" style="color: var(--tg-hint-color);">Прибытие через 3 мин</p>
                </div>
                <button id="call-driver-btn" class="w-14 h-14 rounded-full flex items-center justify-center text-white" style="background-color: var(--tg-button-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>
                </button>
             </div>
             <div class="mt-4 p-3 rounded-xl flex items-center" style="background-color: var(--tg-secondary-bg-color);">
                <div class="w-14 h-14 rounded-full flex items-center justify-center mr-4 flex-shrink-0" style="background-color: var(--tg-bg-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8" style="color: var(--tg-text-color);"><path d="M0 0h24v24H0z" fill="none"/><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>
                </div>
                <div>
                     <p id="driver-info" class="font-semibold" style="color: var(--tg-text-color);">Toyota Camry, A123BC</p>
                     <p id="car-info" class="text-sm" style="color: var(--tg-hint-color);">Черный цвет</p>
                </div>
             </div>
        </div>
        
        <!-- Состояние 4: Поездка завершена -->
        <div id="finished-state" class="hidden text-center py-6 pb-16">
            <h2 class="text-2xl font-bold" style="color: var(--tg-text-color);">Поездка завершена!</h2>
            <p class="text-lg mt-2" style="color: var(--tg-text-color);">К оплате: <span id="final-price" class="font-bold">120₽</span></p>
             <div class="mt-4">
                 <p class="text-md font-semibold" style="color: var(--tg-text-color);">Оцените водителя</p>
                 <div id="rating-stars" class="flex justify-center mt-2">
                    <svg class="rating-star h-10 w-10 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    <svg class="rating-star h-10 w-10 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="2"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    <svg class="rating-star h-10 w-10 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="3"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    <svg class="rating-star h-10 w-10 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    <svg class="rating-star h-10 w-10 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                 </div>
             </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="history-modal" class="modal-content">
        <h2 class="text-2xl font-bold mb-4" style="color: var(--tg-text-color);">История поездок</h2>
        <div id="history-list" class="space-y-3"></div>
    </div>
    <div id="profile-modal" class="modal-content">
        <h2 class="text-2xl font-bold mb-6" style="color: var(--tg-text-color);">Профиль</h2>
        <div class="flex flex-col items-center">
             <div class="w-24 h-24 rounded-full mb-4 flex items-center justify-center" style="background-color: var(--tg-secondary-bg-color);">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" style="color: var(--tg-hint-color);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
             </div>
             <p id="profile-name" class="text-xl font-semibold"></p>
             <p id="profile-username" style="color: var(--tg-hint-color);"></p>
        </div>
    </div>

<script type="module">
    // --- КОНФИГУРАЦИЯ ---
    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q'; // Ваш токен Mapbox
    const KOZMODEMYANSK_COORDS = [46.5700, 56.3333]; // Координаты Козьмодемьянска
    const TARIFFS = {
        standard: { name: 'Стандарт', basePrice: 120, perKm: 15, icon: 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z' },
        comfort: { name: 'Комфорт', basePrice: 180, perKm: 25, icon: 'm21.99 8.01-1.41-1.41-2.52 2.52c-1.38-1.48-3.41-2.35-5.56-2.35-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8c0-2.15-.87-4.18-2.35-5.56l2.52-2.52zm-7.49 11c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z' },
    };
    
    // --- DOM-ЭЛЕМЕНТЫ ---
    const dom = {
        mapControls: document.getElementById('map-controls'),
        historyBtn: document.getElementById('history-btn'),
        profileBtn: document.getElementById('profile-btn'),
        modalOverlay: document.getElementById('modal-overlay'),
        historyModal: document.getElementById('history-modal'),
        profileModal: document.getElementById('profile-modal'),
        tripStatusText: document.getElementById('trip-status-text'),
        driverEta: document.getElementById('driver-eta'),
        driverInfo: document.getElementById('driver-info'),
        carInfo: document.getElementById('car-info'),
        callDriverBtn: document.getElementById('call-driver-btn'),
        finalPrice: document.getElementById('final-price'),
        estimatedTimeDistance: document.getElementById('estimated-time-distance'),
        estimatedPrice: document.getElementById('estimated-price'),
        tripInfoDiv: document.getElementById('trip-info'),
        ratingStars: document.querySelectorAll('.rating-star'),
        tariffSelection: document.getElementById('tariff-selection'),
        states: {
            addressSelection: document.getElementById('address-selection-state'),
            searching: document.getElementById('searching-state'),
            trip: document.getElementById('trip-state'),
            finished: document.getElementById('finished-state'),
        }
    };

    // --- СОСТОЯНИЕ ПРИЛОЖЕНИЯ ---
    let map, userMarker, driverMarker, geocoder;
    let userLocation = null, destinationLocation = null;
    let fromAddressText = 'Ваше местоположение', toAddressText = '';
    let tripHistory = [];
    let state = {
        app: 'addressSelection', // 'addressSelection', 'searching', 'trip', 'finished'
        route: null,
        trip: null,
        selectedTariff: 'standard'
    };
    let currentTripId = null;
    let selectedRating = 0;
    
    const tg = window.Telegram.WebApp;

    // --- ИНИЦИАЛИЗАЦИЯ ---
    function initializeApp() {
        tg.ready();
        tg.expand();
        applyTheme();
        tg.onEvent('themeChanged', applyTheme);
        tg.onEvent('backButtonClicked', closeModal);
        tg.onEvent('mainButtonClicked', onMainButtonClick);
        
        loadTripHistory();
        initializeMap();
        setupEventListeners();
        renderTariffs();
        switchState('addressSelection');
    }

    function applyTheme() {
        const theme = tg.themeParams;
        const root = document.documentElement;
        root.style.setProperty('--tg-bg-color', theme.bg_color || '#ffffff');
        root.style.setProperty('--tg-text-color', theme.text_color || '#000000');
        root.style.setProperty('--tg-hint-color', theme.hint_color || '#999999');
        root.style.setProperty('--tg-button-color', theme.button_color || '#2481cc');
        root.style.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
        root.style.setProperty('--tg-secondary-bg-color', theme.secondary_bg_color || '#f4f4f4');
        root.style.setProperty('--tg-accent-color', theme.button_color || '#2481cc');
    }
    
    function initializeMap() {
        mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
        map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/streets-v12',
            center: KOZMODEMYANSK_COORDS, zoom: 13, pitch: 20
        });
        map.on('load', () => {
            initializeGeocoder();
            setupUserLocation();
        });
    }

    // --- УПРАВЛЕНИЕ СОСТОЯНИЕМ ---
    function switchState(newState) {
        state.app = newState;
        Object.values(dom.states).forEach(el => el.classList.add('hidden'));
        if (dom.states[newState]) dom.states[newState].classList.remove('hidden');
        dom.mapControls.style.display = (newState === 'trip' || newState === 'searching') ? 'none' : 'flex';
        updateMainButton();
    }

    function updateMainButton() {
        switch (state.app) {
            case 'addressSelection':
                if (state.route) {
                    tg.MainButton.setText(`Заказать (${state.route.price}₽)`);
                    tg.MainButton.setParams({ color: tg.themeParams.button_color });
                    tg.MainButton.show().enable();
                } else {
                    tg.MainButton.hide();
                }
                break;
            case 'searching':
                tg.MainButton.setText('Отменить поиск');
                tg.MainButton.setParams({ color: '#ef4444' }); // Red color for cancellation
                tg.MainButton.show().enable();
                break;
            case 'finished':
                tg.MainButton.setText('Новая поездка');
                tg.MainButton.setParams({ color: tg.themeParams.button_color });
                tg.MainButton.show().enable();
                break;
            default:
                tg.MainButton.hide();
                break;
        }
    }

    // --- ЛОГИКА ПОЕЗДКИ ---

    async function handleAddressSelection() {
        if (!userLocation || !destinationLocation) return;
        
        const routeData = await getRouteData(userLocation, destinationLocation);
        if (!routeData) {
            tg.showAlert('Не удалось рассчитать маршрут. Попробуйте другой адрес.');
            return;
        }

        const duration = routeData.duration / 60; // minutes
        const distance = routeData.distance / 1000; // km
        const tariff = TARIFFS[state.selectedTariff];
        const price = Math.round(tariff.basePrice + tariff.perKm * distance);
        
        state.route = { duration, distance, price, geometry: routeData.geometry };

        dom.estimatedTimeDistance.textContent = `${Math.ceil(duration)} мин · ${distance.toFixed(1)} км`;
        dom.estimatedPrice.textContent = `${price}₽`;
        dom.tripInfoDiv.classList.remove('hidden');
        
        drawRoute('estimated-route', state.route.geometry, '#9ca3af');
        updateMainButton();
    }
    
    function startSearch() {
        switchState('searching');
        clearRoute('estimated-route');
        
        const searchTimeout = setTimeout(() => {
            // Имитация: 80% шанс найти водителя
            if (Math.random() < 0.8) {
                startTripSimulation();
            } else {
                tg.showAlert('Свободных водителей не найдено. Попробуйте позже.');
                resetApp();
            }
        }, Math.random() * 5000 + 3000); // 3-8 секунд поиска
        
        state.trip = { searchTimeout };
    }

    function startTripSimulation() {
        switchState('trip');
        
        const driver = { name: 'Алексей', model: 'Toyota Camry', color: 'Черный', plate: 'А123ВС' };
        dom.driverInfo.textContent = `${driver.name} • ${driver.model}, ${driver.plate}`;
        dom.carInfo.textContent = `${driver.color} цвет`;
        
        const driverStartLocation = getRandomNearbyLocation(userLocation);
        createDriverMarker(driverStartLocation);

        dom.tripStatusText.textContent = 'Водитель подъезжает';
        
        // Анимация водителя до пользователя
        animateRoute(driverStartLocation, userLocation, 'pickup', (pickupRoute) => {
            dom.tripStatusText.textContent = 'Водитель ожидает';
            dom.driverEta.textContent = 'Пожалуйста, выходите';
            tg.HapticFeedback.notificationOccurred('success');
            
            setTimeout(() => {
                dom.tripStatusText.textContent = 'В пути';
                dom.callDriverBtn.style.display = 'none';
                
                // Анимация поездки до пункта назначения
                animateRoute(userLocation, destinationLocation, 'dropoff', (dropoffRoute) => {
                    finishTrip(driver, dropoffRoute);
                });
            }, 5000); // 5 секунд ожидания
        });
    }
    
    function finishTrip(driver, finalRouteGeoJSON) {
        currentTripId = Date.now();
        saveTripToHistory({
            id: currentTripId,
            from: fromAddressText, to: toAddressText,
            driver: `${driver.name} • ${driver.model}, ${driver.plate}`,
            route: finalRouteGeoJSON, date: new Date().toLocaleString('ru-RU'),
            distance: state.route.distance.toFixed(1), duration: Math.ceil(state.route.duration),
            price: state.route.price, rating: 0, tariff: state.selectedTariff
        });

        dom.finalPrice.textContent = `${state.route.price}₽`;
        if (driverMarker) driverMarker.remove();
        driverMarker = null;

        switchState('finished');
        tg.HapticFeedback.notificationOccurred('success');
    }

    // --- MAPBOX & ГЕОЛОКАЦИЯ ---

    function setupUserLocation() {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                userLocation = [position.coords.longitude, position.coords.latitude];
                createUserMarker(userLocation);
                map.flyTo({ center: userLocation, zoom: 15 });
                fromAddressText = await getAddressFromCoords(userLocation) || 'Ваше местоположение';
                document.getElementById('from-address').textContent = fromAddressText;
            },
            () => { // Ошибка геолокации
                userLocation = KOZMODEMYANSK_COORDS;
                fromAddressText = 'Центр города';
                document.getElementById('from-address').textContent = fromAddressText;
                createUserMarker(userLocation);
                map.flyTo({ center: userLocation, zoom: 15 });
            },
            { enableHighAccuracy: true }
        );
    }

    async function getAddressFromCoords(coords) {
        try {
            const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords.join(',')}.json?access_token=${MAPBOX_ACCESS_TOKEN}&language=ru`);
            const data = await response.json();
            return data.features?.[0]?.place_name;
        } catch (e) {
            console.error("Geocoding failed", e);
            return null;
        }
    }

    function initializeGeocoder() {
        geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl,
            marker: false, placeholder: 'Куда поедем?',
            bbox: [46.4, 56.2, 46.7, 56.4], // Ограничиваем поиск Козьмодемьянском
            proximity: 'ip', countries: 'ru', language: 'ru-RU'
        });
        document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

        geocoder.on('result', (e) => {
            destinationLocation = e.result.geometry.coordinates;
            toAddressText = e.result.place_name;
            handleAddressSelection();
        });
        geocoder.on('clear', () => {
            destinationLocation = null;
            state.route = null;
            clearRoute('estimated-route');
            dom.tripInfoDiv.classList.add('hidden');
            updateMainButton();
        });
    }

    async function getRouteData(start, end) {
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start.join(',')};${end.join(',')}` +
                      `?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            return data.routes?.[0];
        } catch (error) {
            console.error('Error fetching route:', error);
            return null;
        }
    }

    function drawRoute(id, geometry, color) {
        clearRoute(id);
        if (!map.isStyleLoaded() || !geometry) return;
        const geojson = { type: 'Feature', geometry };
        
        map.addSource(id, { type: 'geojson', data: geojson });
        map.addLayer({ 
            id, type: 'line', source: id,
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': color, 'line-width': 5, 'line-opacity': 0.8 }
        });

        const bounds = geometry.coordinates.reduce((b, coord) => b.extend(coord), new mapboxgl.LngLatBounds());
        map.fitBounds(bounds, { padding: {top: 40, bottom: 350, left: 40, right: 40} });
    }

    function clearRoute(id) {
        if (map.isStyleLoaded()) {
            if (map.getLayer(id)) map.removeLayer(id);
            if (map.getSource(id)) map.removeSource(id);
        }
    }

    // --- АНИМАЦИИ ---
    let animationFrameId;

    async function animateRoute(start, end, tripPhase, onComplete) {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        const routeData = await getRouteData(start, end);
        if (!routeData?.geometry?.coordinates) {
            tg.showAlert('Ошибка построения маршрута. Поездка отменена.');
            resetApp();
            return;
        }
        
        const routeGeometry = routeData.geometry;
        drawRoute('trip-route', routeGeometry, 'var(--tg-accent-color)');

        const routeLine = turf.lineString(routeGeometry.coordinates);
        const routeDistance = turf.length(routeLine);
        const duration = routeData.duration; // in seconds
        let startTime = performance.now();
        let lastBearing = 0;

        function animate(currentTime) {
            const elapsedTime = (currentTime - startTime);
            const progress = Math.min(elapsedTime / (duration * 1000 / 3), 1); // Ускоряем в 3 раза для демо
            
            const currentPoint = turf.along(routeLine, routeDistance * progress);
            const lookAheadPoint = turf.along(routeLine, routeDistance * Math.min(progress + 0.001, 1));
            const bearing = turf.bearing(currentPoint, lookAheadPoint);
            if (!isNaN(bearing)) lastBearing = bearing;
            
            if (driverMarker) {
                driverMarker.setLngLat(currentPoint.geometry.coordinates);
                driverMarker.setRotation(lastBearing);
            }
            if (tripPhase === 'dropoff' && userMarker) {
                userMarker.setLngLat(currentPoint.geometry.coordinates);
                map.panTo(currentPoint.geometry.coordinates);
            }
            
            const etaMinutes = Math.ceil(((1 - progress) * duration) / 60 / 3);
            dom.driverEta.textContent = etaMinutes > 0 ? `Прибытие через ${etaMinutes} мин` : 'Прибыли';

            if (progress >= 1) {
                if (onComplete) onComplete({type: 'Feature', geometry: routeGeometry});
            } else {
                animationFrameId = requestAnimationFrame(animate);
            }
        }
        animationFrameId = requestAnimationFrame(animate);
    }

    // --- UI & РЕНДЕРИНГ ---

    function renderTariffs() {
        dom.tariffSelection.innerHTML = Object.keys(TARIFFS).map(key => {
            const tariff = TARIFFS[key];
            const isSelected = state.selectedTariff === key;
            return `
                <div class="tariff-card text-center cursor-pointer p-2 rounded-xl transition-all duration-200 ${isSelected ? 'font-bold' : ''}" data-tariff="${key}">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2 transition-all duration-200" style="background-color: ${isSelected ? 'var(--tg-accent-color)' : 'var(--tg-secondary-bg-color)'};">
                        <svg viewBox="0 0 24 24" class="w-8 h-8 transition-all duration-200" style="fill: ${isSelected ? 'var(--tg-button-text-color)' : 'var(--tg-text-color)'};">
                            <path d="${tariff.icon}"></path>
                        </svg>
                    </div>
                    <span style="color: ${isSelected ? 'var(--tg-text-color)' : 'var(--tg-hint-color)'};">${tariff.name}</span>
                </div>
            `;
        }).join('');

        document.querySelectorAll('.tariff-card').forEach(card => {
            card.addEventListener('click', (e) => {
                state.selectedTariff = e.currentTarget.dataset.tariff;
                renderTariffs(); // Re-render to update styles
                if (state.route) handleAddressSelection(); // Recalculate price
                tg.HapticFeedback.selectionChanged();
            });
        });
    }

    function createUserMarker(coords) {
        if (userMarker) {
            userMarker.setLngLat(coords);
        } else {
            const el = document.createElement('div');
            el.className = 'user-marker';
            userMarker = new mapboxgl.Marker(el).setLngLat(coords).addTo(map);
        }
    }
    
    function createDriverMarker(coords) {
        const el = document.createElement('div');
        el.className = 'driver-marker';
        driverMarker = new mapboxgl.Marker(el).setLngLat(coords).addTo(map);
    }
    
    function getRandomNearbyLocation(baseLocation) {
        const offset = 0.02; // ~2km
        return [baseLocation[0] + (Math.random() - 0.5) * offset, baseLocation[1] + (Math.random() - 0.5) * offset];
    }
    
    // --- ИСТОРИЯ, ПРОФИЛЬ, МОДАЛЬНЫЕ ОКНА ---

    function loadTripHistory() {
        tg.CloudStorage.getItem('trip_history_v2', (err, value) => {
            if (value) {
                try { tripHistory = JSON.parse(value); } catch(e) { tripHistory = []; }
            }
        });
    }

    function saveTripToHistory(trip) {
        const index = tripHistory.findIndex(t => t.id === trip.id);
        if (index !== -1) {
            tripHistory[index] = trip;
        } else {
            tripHistory.unshift(trip);
            if (tripHistory.length > 20) tripHistory.pop(); // Ограничиваем историю
        }
        tg.CloudStorage.setItem('trip_history_v2', JSON.stringify(tripHistory));
    }
    
    function renderHistory() {
        const listEl = document.getElementById('history-list');
        listEl.innerHTML = tripHistory.length === 0
            ? `<p style="color: var(--tg-hint-color);">У вас пока нет поездок.</p>`
            : tripHistory.map(trip => `
                <div class="p-3 rounded-lg cursor-pointer hover:opacity-80" style="background-color: var(--tg-secondary-bg-color);" data-route='${JSON.stringify(trip.route)}'>
                    <p class="font-semibold truncate" style="color: var(--tg-text-color);">${trip.to.split(',')[0]}</p>
                    <p class="text-sm truncate" style="color: var(--tg-hint-color);">${trip.from.split(',')[0]}</p>
                    <p class="text-xs mt-1" style="color: var(--tg-hint-color);">${trip.date}</p>
                    <div class="text-xs flex items-center mt-1" style="color: var(--tg-hint-color);">
                        <span>${trip.price}₽</span><span class="mx-1.5">•</span>
                        <span>${TARIFFS[trip.tariff]?.name || 'Стандарт'}</span><span class="mx-1.5">•</span>
                        <span class="flex items-center">
                          ${trip.rating || '–'} <svg class="w-3 h-3 ml-0.5" fill="#fbbf24" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        </span>
                    </div>
                </div>
            `).join('');
        
        listEl.querySelectorAll('[data-route]').forEach(el => {
            el.addEventListener('click', (e) => {
                const route = JSON.parse(e.currentTarget.dataset.route);
                if (route) showHistoryRoute(route);
            });
        });
    }

    function showHistoryRoute(route) {
        closeModal();
        clearRoute('estimated-route');
        clearRoute('trip-route');
        drawRoute('history-route', route.geometry, '#9ca3af');
    }
    
    function renderProfile() {
        const user = tg.initDataUnsafe.user;
        if (user) {
            document.getElementById('profile-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`;
            document.getElementById('profile-username').textContent = user.username ? `@${user.username}` : 'Username не указан';
        }
    }
    
    function openModal(modal) {
        modal.classList.add('active');
        dom.modalOverlay.classList.add('active');
        tg.BackButton.show();
    }
    
    function closeModal() {
        document.querySelectorAll('.modal-content.active').forEach(m => m.classList.remove('active'));
        dom.modalOverlay.classList.remove('active');
        tg.BackButton.hide();
        clearRoute('history-route');
    }

    // --- СБРОС И УТИЛИТЫ ---
    function resetApp() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        if (state.trip?.searchTimeout) clearTimeout(state.trip.searchTimeout);

        clearRoute('trip-route');
        clearRoute('estimated-route');
        if (driverMarker) { driverMarker.remove(); driverMarker = null; }
        if (geocoder) geocoder.clear();
        
        destinationLocation = null;
        state.route = null;
        state.trip = null;
        
        dom.tripInfoDiv.classList.add('hidden');
        dom.callDriverBtn.style.display = 'flex';
        resetRatingStars();
        
        if (userLocation) {
            map.flyTo({ center: userLocation, zoom: 15 });
            if (userMarker) userMarker.setLngLat(userLocation);
        }
        
        switchState('addressSelection');
    }
    
    function resetRatingStars() {
        dom.ratingStars.forEach(star => {
            star.classList.remove('selected');
            star.style.color = '';
        });
        selectedRating = 0;
    }

    // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
    function setupEventListeners() {
        dom.historyBtn.addEventListener('click', () => { renderHistory(); openModal(dom.historyModal); });
        dom.profileBtn.addEventListener('click', () => { renderProfile(); openModal(dom.profileModal); });
        dom.modalOverlay.addEventListener('click', closeModal);
        dom.callDriverBtn.addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('light');
            tg.showAlert('Звонок водителю (симуляция)');
        });
        
        dom.ratingStars.forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.rating);
                dom.ratingStars.forEach(s => {
                    const isSelected = parseInt(s.dataset.rating) <= selectedRating;
                    s.classList.toggle('selected', isSelected);
                    s.style.color = isSelected ? '#fbbf24' : '';
                });
                const trip = tripHistory.find(t => t.id === currentTripId);
                if (trip) {
                    trip.rating = selectedRating;
                    saveTripToHistory(trip);
                }
                tg.HapticFeedback.notificationOccurred('success');
            });
        });
    }

    function onMainButtonClick() {
        tg.HapticFeedback.impactOccurred('medium');
        switch (state.app) {
            case 'addressSelection':
                tg.showConfirm(`Подтверждаете заказ за ${state.route.price}₽?`, (confirmed) => {
                    if (confirmed) startSearch();
                });
                break;
            case 'searching':
                resetApp();
                tg.HapticFeedback.notificationOccurred('warning');
                break;
            case 'finished':
                resetApp();
                break;
        }
    }
    
    // --- ЗАПУСК ---
    initializeApp();

</script>
</body>
</html>
