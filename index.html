<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
    <title>Telegram Такси</title>

    <!-- Telegram Mini Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Mapbox -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />

    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" />

    <!-- Turf.js для анимации -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Шрифты -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        /* Переменные для темы из Telegram */
        :root {
            --tg-bg-color: #111827; /* bg-gray-900 */
            --tg-text-color: #ffffff;
            --tg-hint-color: #9CA3AF; /* text-gray-400 */
            --tg-button-color: #3B82F6; /* bg-blue-500 */
            --tg-button-text-color: #ffffff;
            --tg-secondary-bg-color: #1F2937; /* bg-gray-800 */
            --tg-accent-color: #3B82F6;
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
        }
        .view { display: none; }
        .view.active { display: block; }
        #map { position: absolute; inset: 0; }
        .mapboxgl-ctrl-geocoder--logo { display: none !important; }

        .user-marker {
            width: 20px; height: 20px; background-color: #007BFF;
            border: 3px solid var(--tg-bg-color); border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        .driver-marker {
            width: 40px; height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="-2 -2 28 28" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99z"/></svg>');
            background-size: 60%; background-position: center; background-repeat: no-repeat;
            background-color: #2a2a2a; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .mapboxgl-ctrl-geocoder, .mapboxgl-ctrl-geocoder--input {
            background-color: var(--tg-secondary-bg-color);
            color: var(--tg-text-color);
        }
        .mapboxgl-ctrl-geocoder {
            width: 100% !important; max-width: none !important; font-size: 1rem !important;
            box-shadow: none !important; border-radius: 0.75rem !important; border: 1px solid var(--tg-secondary-bg-color);
        }
        .mapboxgl-ctrl-geocoder--input { height: 50px !important; padding-left: 40px !important; }
        .mapboxgl-ctrl-geocoder--icon-search { top: 13px !important; left: 10px !important; }
        .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right > * { top: 15px !important; right: 10px !important; }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); border-radius: 50%;
            border-top: 4px solid var(--tg-text-color); width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            opacity: 0; transition: opacity 0.3s ease-in-out;
            pointer-events: none; z-index: 40;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 80vh; background: var(--tg-bg-color); color: var(--tg-text-color);
            border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem;
            transform: translateY(100%); transition: transform 0.3s ease-in-out;
            z-index: 50; padding: 1.5rem; overflow-y: auto; box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
        }
        .modal-content.active { transform: translateY(0); }

        .rating-star { cursor: pointer; transition: color 0.2s; }
        .rating-star:hover, .rating-star.selected { color: #fbbf24; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1c1c1d; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app-container" class="h-full w-full">

        <!-- Экран выбора роли -->
        <div id="role-selection-view" class="view active flex flex-col items-center justify-center h-full p-6 text-center">
            <h1 class="text-4xl font-bold mb-4">Добро пожаловать!</h1>
            <p class="text-gray-400 mb-12">Выберите вашу роль, чтобы продолжить.</p>
            <div class="w-full max-w-xs space-y-4">
                <button onclick="selectRole('client')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-xl transition duration-300 shadow-lg">
                    Я пассажир
                </button>
                <button onclick="selectRole('driver')" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-4 rounded-xl transition duration-300 shadow-lg">
                    Я водитель
                </button>
            </div>
        </div>

        <!-- Новый интерфейс клиента с картой -->
        <div id="client-map-view" class="view h-full w-full relative">
            <div id="map"></div>
            <!-- Верхние кнопки -->
            <div id="history-btn" class="absolute top-4 left-4 rounded-full p-3 shadow-lg cursor-pointer z-10" style="background-color: var(--tg-bg-color);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--tg-text-color);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div id="profile-btn" class="absolute top-4 right-4 rounded-full p-3 shadow-lg cursor-pointer z-10" style="background-color: var(--tg-bg-color);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--tg-text-color);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <!-- Нижняя плашка -->
            <div id="bottom-sheet" class="fixed bottom-0 left-0 right-0 rounded-t-2xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.2)] p-4 transform translate-y-0 transition-transform duration-300 ease-in-out z-20" style="background-color: var(--tg-bg-color);">
                <div id="address-selection-state" class="pb-16">
                    <div class="space-y-3">
                        <div class="flex items-center p-3 rounded-xl justify-between" style="background-color: var(--tg-secondary-bg-color);"><div class="flex items-center min-w-0"><div class="w-4 h-4 rounded-full bg-blue-500 border-2 border-white ring-2 ring-blue-500 mr-3 flex-shrink-0"></div><span class="font-medium w-full truncate" id="from-address" style="color: var(--tg-text-color);">Ваше местоположение</span></div><div class="flex items-center gap-2 flex-shrink-0"><button id="btn-my-location" class="px-2 py-1 rounded text-sm" style="background-color: var(--tg-button-color); color: var(--tg-button-text-color);">Моё</button><button id="btn-pick-on-map" class="px-2 py-1 rounded text-sm" style="background-color: var(--tg-bg-color); color: var(--tg-text-color); border: 1px solid var(--tg-secondary-bg-color);">Указать</button></div></div>
                        <div id="chips-row" class="flex gap-2"><button id="chip-home" class="px-3 py-1 rounded-full text-sm" style="background-color: var(--tg-secondary-bg-color);">Дом</button><button id="chip-work" class="px-3 py-1 rounded-full text-sm" style="background-color: var(--tg-secondary-bg-color);">Работа</button><button id="chip-recent" class="px-3 py-1 rounded-full text-sm" style="background-color: var(--tg-secondary-bg-color);">Недавние</button></div>
                        <div id="geocoder-container"></div>
                        <div id="trip-info" class="mt-2 p-3 rounded-xl hidden" style="background-color: var(--tg-secondary-bg-color);"><div class="flex justify-between items-center"><div><p id="estimated-time" class="font-semibold" style="color: var(--tg-text-color);"></p><p id="estimated-distance" class="text-sm" style="color: var(--tg-hint-color);"></p><div class="text-sm mt-1 flex items-center gap-2"><span id="estimated-price" class="font-bold" style="color: var(--tg-text-color);"></span><span id="surge-badge" class="hidden text-xs px-2 py-0.5 rounded-full" style="background:#fde68a; color:#92400e;">Повышенный спрос</span></div></div><div class="text-right"><div id="pay-badge" class="inline-block text-xs px-2 py-1 rounded border cursor-pointer" style="border-color: var(--tg-hint-color); color: var(--tg-text-color);">Оплата: Наличные</div><div class="mt-2"><button id="promo-btn" class="text-xs underline" style="color: var(--tg-text-color);">Промокод</button></div></div></div><div class="grid grid-cols-3 gap-2 mt-3"><div id="tariff-economy" class="p-2 rounded border cursor-pointer"><p class="font-semibold">Эконом</p><p class="text-xs" style="color: var(--tg-hint-color);">Выгодно</p><p id="price-economy" class="text-sm font-bold mt-1">—</p></div><div id="tariff-comfort" class="p-2 rounded border cursor-pointer"><p class="font-semibold">Комфорт</p><p class="text-xs" style="color: var(--tg-hint-color);">Удобно</p><p id="price-comfort" class="text-sm font-bold mt-1">—</p></div><div id="tariff-van" class="p-2 rounded border cursor-pointer"><p class="font-semibold">Минивэн</p><p class="text-xs" style="color: var(--tg-hint-color);">Компания</p><p id="price-van" class="text-sm font-bold mt-1">—</p></div></div></div>
                    </div>
                </div>
                <div id="searching-state" class="hidden text-center py-4 pb-16"><div class="flex items-center justify-center"><div class="spinner mr-4"></div><p class="text-lg font-semibold" style="color: var(--tg-text-color);">Ищем водителя...</p></div><p class="mt-1" style="color: var(--tg-hint-color);">Это может занять до минуты</p></div>
                <div id="trip-state" class="hidden pb-16"><div class="flex items-center"><div class="w-16 h-16 rounded-full flex items-center justify-center mr-4 flex-shrink-0" style="background-color: var(--tg-secondary-bg-color);"><svg xmlns="http://www.w3.org/2000/svg" viewBox="-2 -2 28 28" fill="currentColor" class="w-8 h-8" style="color: var(--tg-text-color);"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99z"/></svg></div><div><p id="trip-status-text" class="text-lg font-bold" style="color: var(--tg-text-color);">Водитель подъезжает</p><p id="driver-eta" style="color: var(--tg-hint-color);">Прибытие через 3 мин</p></div></div><div class="mt-3 p-3 rounded-xl" style="background-color: var(--tg-secondary-bg-color);"><p id="driver-info" class="font-semibold" style="color: var(--tg-text-color);">Toyota Camry, A123BC</p><p id="car-info" class="text-sm" style="color: var(--tg-hint-color);">Черный цвет</p></div><div class="mt-3 flex gap-2"><button id="call-driver-btn" class="px-4 py-2 rounded-lg text-white" style="background-color: var(--tg-button-color);">Позвонить водителю</button><button id="share-trip-btn" class="px-4 py-2 rounded-lg" style="background-color: var(--tg-secondary-bg-color); color: var(--tg-text-color);">Поделиться</button><button id="safety-btn" class="px-4 py-2 rounded-lg" style="background-color: var(--tg-secondary-bg-color); color: var(--tg-text-color);">Безопасность</button></div></div>
                <div id="finished-state" class="hidden text-center py-6 pb-16"><h2 class="text-2xl font-bold" style="color: var(--tg-text-color);">Поездка завершена!</h2><p class="text-lg mt-2" style="color: var(--tg-text-color);">К оплате: <span id="final-price" class="font-bold">120₽ наличными</span></p><div class="mt-4"><p class="text-md font-semibold" style="color: var(--tg-text-color);">Оцените поездку</p><div id="rating-stars" class="flex justify-center mt-2"><svg class="rating-star h-8 w-8 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 2.93c.3-.92 1.6-.92 1.9 0l1.52 4.67a1 1 0 0 0 .95.69h4.91c.97 0 1.37 1.24.59 1.81l-3.98 2.89a1 1 0 0 0-.36 1.12l1.52 4.67c.3.92-.75 1.69-1.54 1.12l-3.98-2.89a1 1 0 0 0-1.18 0l-3.98 2.89c-.78.57-1.84-.2-1.54-1.12l1.52-4.67a1 1 0 0 0-.36-1.12L3.08 10.1c-.79-.57-.39-1.81.59-1.81h4.91a1 1 0 0 0 .95-.69l1.52-4.67z"/></svg><svg class="rating-star h-8 w-8 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="2"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 2.93c.3-.92 1.6-.92 1.9 0l1.52 4.67a1 1 0 0 0 .95.69h4.91c.97 0 1.37 1.24.59 1.81l-3.98 2.89a1 1 0 0 0-.36 1.12l1.52 4.67c.3.92-.75 1.69-1.54 1.12l-3.98-2.89a1 1 0 0 0-1.18 0l-3.98 2.89c-.78.57-1.84-.2-1.54-1.12l1.52-4.67a1 1 0 0 0-.36-1.12L3.08 10.1c-.79-.57-.39-1.81.59-1.81h4.91a1 1 0 0 0 .95-.69l1.52-4.67z"/></svg><svg class="rating-star h-8 w-8 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="3"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 2.93c.3-.92 1.6-.92 1.9 0l1.52 4.67a1 1 0 0 0 .95.69h4.91c.97 0 1.37 1.24.59 1.81l-3.98 2.89a1 1 0 0 0-.36 1.12l1.52 4.67c.3.92-.75 1.69-1.54 1.12l-3.98-2.89a1 1 0 0 0-1.18 0l-3.98 2.89c-.78.57-1.84-.2-1.54-1.12l1.52-4.67a1 1 0 0 0-.36-1.12L3.08 10.1c-.79-.57-.39-1.81.59-1.81h4.91a1 1 0 0 0 .95-.69l1.52-4.67z"/></svg><svg class="rating-star h-8 w-8 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 2.93c.3-.92 1.6-.92 1.9 0l1.52 4.67a1 1 0 0 0 .95.69h4.91c.97 0 1.37 1.24.59 1.81l-3.98 2.89a1 1 0 0 0-.36 1.12l1.52 4.67c.3.92-.75 1.69-1.54 1.12l-3.98-2.89a1 1 0 0 0-1.18 0l-3.98 2.89c-.78.57-1.84-.2-1.54-1.12l1.52-4.67a1 1 0 0 0-.36-1.12L3.08 10.1c-.79-.57-.39-1.81.59-1.81h4.91a1 1 0 0 0 .95-.69l1.52-4.67z"/></svg><svg class="rating-star h-8 w-8 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-rating="5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 2.93c.3-.92 1.6-.92 1.9 0l1.52 4.67a1 1 0 0 0 .95.69h4.91c.97 0 1.37 1.24.59 1.81l-3.98 2.89a1 1 0 0 0-.36 1.12l1.52 4.67c.3.92-.75 1.69-1.54 1.12l-3.98-2.89a1 1 0 0 0-1.18 0l-3.98 2.89c-.78.57-1.84-.2-1.54-1.12l1.52-4.67a1 1 0 0 0-.36-1.12L3.08 10.1c-.79-.57-.39-1.81.59-1.81h4.91a1 1 0 0 0 .95-.69l1.52-4.67z"/></svg></div></div></div>
            </div>
             <!-- Модалки -->
            <div id="modal-overlay" class="modal-overlay"></div>
            <div id="history-modal" class="modal-content"><h2 class="text-2xl font-bold mb-4" style="color: var(--tg-text-color);">История поездок</h2><div id="history-list" class="space-y-3"></div></div>
            <div id="profile-modal" class="modal-content"><h2 class="text-2xl font-bold mb-6" style="color: var(--tg-text-color);">Профиль</h2><div class="flex flex-col items-center"><div class="w-24 h-24 rounded-full mb-4 flex items-center justify-center" style="background-color: var(--tg-secondary-bg-color);"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" style="color: var(--tg-hint-color);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></div><p id="profile-name" class="text-xl font-semibold"></p><p id="profile-username" style="color: var(--tg-hint-color);"></p></div></div>
        </div>

        <!-- Интерфейс водителя (без изменений) -->
        <div id="driver-view" class="view h-full flex flex-col">
            <header class="p-4 bg-gray-800/80 backdrop-blur-sm flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold">Режим водителя</h2>
                    <div id="driver-user-info" class="text-left text-sm text-gray-400"></div>
                </div>
                <button id="status-toggle-btn" class="px-4 py-2 rounded-lg font-semibold transition-colors duration-300">На линию</button>
            </header>
            <div id="driver-content" class="flex-grow p-4 overflow-y-auto">
                <div id="offline-state" class="text-center py-20"><p class="text-gray-500">Вы не на линии. Нажмите "На линию", чтобы начать получать заказы.</p></div>
                <div id="online-state" class="hidden"><h3 class="font-bold text-lg mb-4">Доступные заказы:</h3><div id="requests-list" class="space-y-3"><div class="text-center py-10 text-gray-500">Поиск доступных заказов...</div></div></div>
                <div id="on-trip-state" class="hidden p-4 bg-gray-800 rounded-lg text-center"><h3 class="font-bold text-lg mb-2">Вы на заказе</h3><div id="trip-client-info"></div><button onclick="finishTrip()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300">Завершить поездку</button></div>
            </div>
        </div>
    </div>

    <script>
        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : {};

        // ----- ОБЩАЯ ЛОГИКА ПРИЛОЖЕНИЯ -----
        const appState = {
            role: null,
            driverStatus: 'offline',
            availableRides: [ // Mock данные для водителя
                { id: 1, from: 'Проспект Ленина, 1', to: 'Улица Пушкина, 10', price: 150 },
                { id: 2, from: 'ТЦ "Галактика"', to: 'Аэропорт', price: 500 },
            ],
            currentDriverTrip: null,
        };

        const views = {
            roleSelection: document.getElementById('role-selection-view'),
            clientMap: document.getElementById('client-map-view'),
            driver: document.getElementById('driver-view')
        };
        
        function initializeApp() {
            if(tg.ready) {
                tg.ready();
                tg.expand();
            }
        }

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.remove('active'));
            if (views[viewName]) {
                views[viewName].classList.add('active');
            }
        }
        
        let clientAppInitialized = false;
        function selectRole(role) {
            appState.role = role;
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            
            if (role === 'client') {
                showView('clientMap');
                if (!clientAppInitialized) {
                    initializeClientApp();
                    clientAppInitialized = true;
                }
            } else if (role === 'driver') {
                showView('driver');
                setupDriverView();
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);

        // ----- ЛОГИКА ИНТЕРФЕЙСА ВОДИТЕЛЯ (из старой версии) -----
        const driverElements = {
            statusBtn: document.getElementById('status-toggle-btn'),
            offlineState: document.getElementById('offline-state'),
            onlineState: document.getElementById('online-state'),
            onTripState: document.getElementById('on-trip-state'),
            requestsList: document.getElementById('requests-list'),
            tripClientInfo: document.getElementById('trip-client-info'),
            userInfo: document.getElementById('driver-user-info')
        };

        function setupDriverView() {
            const user = tg.initDataUnsafe?.user;
            if (user?.first_name) {
                driverElements.userInfo.innerText = `Водитель: ${user.first_name}`;
            }
            driverElements.statusBtn.addEventListener('click', toggleDriverStatus);
            if(tg.MainButton) tg.MainButton.hide();
            renderDriverView();
        }

        function toggleDriverStatus() {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            appState.driverStatus = (appState.driverStatus === 'offline') ? 'online' : 'offline';
            renderDriverView();
        }

        function renderDriverView() { /* ... код без изменений ... */ }
        function renderRequestsList() { /* ... код без изменений ... */ }
        function acceptRide(rideId) { /* ... код без изменений ... */ }
        function renderCurrentTripInfo() { /* ... код без изменений ... */ }
        function finishTrip() { /* ... код без изменений ... */ }
        
        // Вспомогательные функции для водителя
        function renderDriverView() {
            const { statusBtn, offlineState, onlineState, onTripState } = driverElements;
            offlineState.style.display = 'none';
            onlineState.style.display = 'none';
            onTripState.style.display = 'none';
            switch (appState.driverStatus) {
                case 'offline':
                    statusBtn.innerText = 'На линию';
                    statusBtn.className = 'px-4 py-2 rounded-lg font-semibold transition-colors duration-300 bg-green-600 hover:bg-green-700';
                    offlineState.style.display = 'block'; break;
                case 'online':
                    statusBtn.innerText = 'Уйти с линии';
                    statusBtn.className = 'px-4 py-2 rounded-lg font-semibold transition-colors duration-300 bg-yellow-500 hover:bg-yellow-600';
                    onlineState.style.display = 'block'; renderRequestsList(); break;
                case 'on-trip':
                    statusBtn.innerText = 'На заказе';
                    statusBtn.className = 'px-4 py-2 rounded-lg font-semibold transition-colors duration-300 bg-gray-500 cursor-not-allowed';
                    onTripState.style.display = 'block'; renderCurrentTripInfo(); break;
            }
        }
        function renderRequestsList() {
            const list = driverElements.requestsList;
            list.innerHTML = '';
            if (appState.availableRides.length === 0) {
                 list.innerHTML = `<div class="text-center py-10 text-gray-500">Нет доступных заказов.</div>`; return;
            }
            appState.availableRides.forEach(ride => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg shadow-md';
                card.innerHTML = `<div class="flex justify-between items-center"><div><p class="text-sm text-gray-400">Откуда:</p><p class="font-semibold">${ride.from}</p></div><div class="text-2xl font-bold text-green-400">${ride.price} ₽</div></div><div class="mt-2"><p class="text-sm text-gray-400">Куда:</p><p>${ride.to}</p></div><button onclick="acceptRide(${ride.id})" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Принять заказ</button>`;
                list.appendChild(card);
            });
        }
        function acceptRide(rideId) {
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            const ride = appState.availableRides.find(r => r.id === rideId);
            appState.currentDriverTrip = { ...ride, client: { name: 'Елена', phone: '+7 ...' } };
            appState.driverStatus = 'on-trip';
            appState.availableRides = appState.availableRides.filter(r => r.id !== rideId);
            renderDriverView();
        }
        function renderCurrentTripInfo() {
            const { client, from, to, price } = appState.currentDriverTrip;
            driverElements.tripClientInfo.innerHTML = `<p>Клиент: <strong>${client.name}</strong></p><p>Маршрут: <strong>${from} &rarr; ${to}</strong></p><p>Стоимость: <strong class="text-green-400">${price} ₽</strong></p>`;
        }
        function finishTrip() {
            if (tg.showConfirm) tg.showConfirm("Завершить текущую поездку?", (confirmed) => {
                if (confirmed) {
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    appState.driverStatus = 'online';
                    appState.currentDriverTrip = null;
                    renderDriverView();
                }
            });
        }


        // ----- ЛОГИКА ИНТЕРФЕЙСА КЛИЕНТА (из нового кода) -----
        function initializeClientApp() {
            // Весь код из нового файла будет здесь, обернутый в эту функцию
            (function() {
                // ====== CONFIG ======
                const DEFAULT_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
                const MAPBOX_ACCESS_TOKEN = (window.MAPBOX_ACCESS_TOKEN) || (new URLSearchParams(location.search).get('mb')) || DEFAULT_TOKEN;
                const CITY_CENTER = [46.5700, 56.3333]; // Kozmodemyansk [lng, lat]
                const TARIFFS = { economy: { name: 'Эконом', base: 60, perKm: 16, perMin: 4, minFare: 99 }, comfort: { name: 'Комфорт', base: 80, perKm: 22, perMin: 6, minFare: 149 }, van: { name: 'Минивэн', base: 120, perKm: 30, perMin: 8, minFare: 249 } };
                const SURGE_RULES = [ { hours: [7, 10], mult: 1.2 }, { hours: [17, 20], mult: 1.25 } ];
                const FAKE_DRIVERS = [ { name: 'Алексей', model: 'Toyota Camry', color: 'Чёрный' }, { name: 'Мария', model: 'Hyundai Solaris', color: 'Белый' }, { name: 'Дмитрий', model: 'Kia Rio', color: 'Серебристый' }, { name: 'Ольга', model: 'Volkswagen Polo', color: 'Синий' }, { name: 'Сергей', model: 'Ford Focus', color: 'Красный' } ];
                
                // ====== DOM ======
                const historyBtn = document.getElementById('history-btn');
                const profileBtn = document.getElementById('profile-btn');
                const modalOverlay = document.getElementById('modal-overlay');
                const historyModal = document.getElementById('history-modal');
                const profileModal = document.getElementById('profile-modal');
                const fromAddressEl = document.getElementById('from-address');
                const btnMyLocation = document.getElementById('btn-my-location');
                const btnPickOnMap = document.getElementById('btn-pick-on-map');
                const chipHome = document.getElementById('chip-home');
                const chipWork = document.getElementById('chip-work');
                const chipRecent = document.getElementById('chip-recent');
                const tripInfoDiv = document.getElementById('trip-info');
                const estimatedTimeEl = document.getElementById('estimated-time');
                const estimatedDistanceEl = document.getElementById('estimated-distance');
                const estimatedPriceEl = document.getElementById('estimated-price');
                const surgeBadge = document.getElementById('surge-badge');
                const payBadge = document.getElementById('pay-badge');
                const promoBtn = document.getElementById('promo-btn');
                const tileEconomy = document.getElementById('tariff-economy');
                const tileComfort = document.getElementById('tariff-comfort');
                const tileVan = document.getElementById('tariff-van');
                const priceEconomy = document.getElementById('price-economy');
                const priceComfort = document.getElementById('price-comfort');
                const priceVan = document.getElementById('price-van');
                const states = { addressSelection: document.getElementById('address-selection-state'), searching: document.getElementById('searching-state'), trip: document.getElementById('trip-state'), finished: document.getElementById('finished-state') };
                const tripStatusText = document.getElementById('trip-status-text');
                const driverEtaEl = document.getElementById('driver-eta');
                const driverInfoEl = document.getElementById('driver-info');
                const carInfoEl = document.getElementById('car-info');
                const callDriverBtn = document.getElementById('call-driver-btn');
                const shareTripBtn = document.getElementById('share-trip-btn');
                const safetyBtn = document.getElementById('safety-btn');
                const finalPriceEl = document.getElementById('final-price');
                const ratingStars = document.querySelectorAll('.rating-star');

                // ====== STATE ======
                let map, geocoder;
                let userMarker, driverMarker;
                let nearbyDrivers = [];
                let userLocation = null, destinationLocation = null;
                let fromAddressText = 'Ваше местоположение', toAddressText = '';
                let animationFrameId = null, cancelTimerInterval = null, findDriverTimeout = null;
                let routeAbortController = null;
                let tripHistory = [];
                let currentAppState = 'addressSelection';
                let currentTariff = 'economy';
                let payment = 'cash';
                let promo = null;
                let estimatedDuration = 0, estimatedDistance = 0, calculatedPrice = 0, surgeMult = 1;
                let currentTripId = null;
                let selectedRating = 0;
                const layerStore = { estimated: null, active: null, history: null };
                let presets = { home: null, work: null };
                let recents = [];
                let pickOnMapMode = false;

                // ====== ИНИЦИАЛИЗАЦИЯ КЛИЕНТА ======
                function applyTheme() {
                     const theme = (tg && tg.themeParams) || {};
                     const r = document.documentElement.style;
                     r.setProperty('--tg-bg-color', theme.bg_color || '#111827');
                     r.setProperty('--tg-text-color', theme.text_color || '#ffffff');
                     r.setProperty('--tg-hint-color', theme.hint_color || '#9CA3AF');
                     r.setProperty('--tg-button-color', theme.button_color || '#3B82F6');
                     r.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
                     r.setProperty('--tg-secondary-bg-color', theme.secondary_bg_color || '#1F2937');
                     r.setProperty('--tg-accent-color', theme.link_color || '#3B82F6');
                     if (tg.setHeaderColor) {
                         tg.setHeaderColor(theme.bg_color || '#111827');
                         tg.setBackgroundColor(theme.bg_color || '#111827');
                     }
                     try {
                         const style = isDark(theme.bg_color) ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/streets-v12';
                         if (map && style && map.getStyle()?.sprite?.indexOf(style) === -1) {
                             map.setStyle(style);
                             map.once('styledata', () => readdAllLayers());
                         }
                     } catch {}
                }
                function isDark(hex) {
                    if (!hex || typeof hex !== 'string') return false;
                    const v = hex.replace('#','');
                    if (![6,8].includes(v.length)) return false;
                    const r = parseInt(v.slice(0,2), 16), g = parseInt(v.slice(2,4), 16), b = parseInt(v.slice(4,6), 16);
                    const y = 0.2126*Math.pow(r/255,2.2) + 0.7152*Math.pow(g/255,2.2) + 0.0722*Math.pow(b/255,2.2);
                    return y < 0.5;
                }
                if (tg.onEvent) {
                    tg.onEvent('themeChanged', applyTheme);
                    tg.onEvent('backButtonClicked', onBackButton);
                    tg.onEvent('mainButtonClicked', onMainButtonClick);
                }
                applyTheme();
                loadPersistedData();
                updatePaymentBadge();
                updateTariffUI();
                updateMainButton();
                initializeMap();

                // Остальной JS код клиента без изменений...
                // ... (вся логика карты, маршрутов, симуляции, UI)
                function initializeMap() {
                    if (!MAPBOX_ACCESS_TOKEN || MAPBOX_ACCESS_TOKEN === 'REPLACE_WITH_YOUR_MAPBOX_TOKEN') { (tg.showAlert ? tg.showAlert : alert)('Не задан Mapbox token.'); }
                    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
                    map = new mapboxgl.Map({ container: 'map', style: isDark(tg.themeParams?.bg_color) ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/streets-v12', center: CITY_CENTER, zoom: 13, pitch: 20 });
                    map.on('load', () => { initializeGeocoder(); setupUserLocation(); placeNearbyDrivers(); });
                    map.on('click', (e) => { if (pickOnMapMode) { const lngLat = e.lngLat.wrap(); userLocation = [lngLat.lng, lngLat.lat]; setOrMoveUserMarker(userLocation); reverseGeocode(userLocation).then(name => { fromAddressText = name || 'Точка на карте'; fromAddressEl.textContent = fromAddressText; geocoder.setProximity({ longitude: userLocation[0], latitude: userLocation[1] }); }); setPickOnMapMode(false); if (destinationLocation) showEstimatedRouteAndInfo(); } });
                }
                function initializeGeocoder() {
                    geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker: false, placeholder: 'Куда поедем?', bbox: [46.4, 56.2, 46.7, 56.4], countries: 'ru', language: 'ru-RU' });
                    document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));
                    geocoder.on('result', async (e) => { destinationLocation = e.result.geometry.coordinates; toAddressText = e.result.place_name || ''; pushRecent({ lng: destinationLocation[0], lat: destinationLocation[1], placeName: toAddressText }); await showEstimatedRouteAndInfo(); updateMainButton(); });
                    geocoder.on('clear', () => { destinationLocation = null; removeRouteLayer('estimated-route'); layerStore.estimated = null; tripInfoDiv.classList.add('hidden'); updateMainButton(); });
                }
                function setupUserLocation() { navigator.geolocation.getCurrentPosition( async (pos) => { userLocation = [pos.coords.longitude, pos.coords.latitude]; setOrMoveUserMarker(userLocation); map.flyTo({ center: userLocation, zoom: 15 }); try { geocoder.setProximity({ longitude: userLocation[0], latitude: userLocation[1] }); } catch {} try { const name = await reverseGeocode(userLocation); fromAddressText = name || fromAddressText; fromAddressEl.textContent = fromAddressText; } catch {} }, () => { userLocation = CITY_CENTER; setOrMoveUserMarker(userLocation); map.flyTo({ center: userLocation, zoom: 15 }); fromAddressText = 'Центр города'; fromAddressEl.textContent = fromAddressText; }, { enableHighAccuracy: true, timeout: 10000 } ); }
                function reverseGeocode([lng, lat]) { const u = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${encodeURIComponent(MAPBOX_ACCESS_TOKEN)}&language=ru`; return fetch(u).then(r => r.json()).then(j => j.features?.[0]?.place_name || ''); }
                function setOrMoveUserMarker(ll) { if (userMarker) userMarker.setLngLat(ll); else { const el = document.createElement('div'); el.className = 'user-marker'; userMarker = new mapboxgl.Marker(el).setLngLat(ll).addTo(map); } }
                function placeNearbyDrivers() { clearNearbyDrivers(); const count = 4 + Math.floor(Math.random() * 3); for (let i = 0; i < count; i++) { const coord = [(CITY_CENTER[0] + (Math.random() - 0.5) * 0.02), (CITY_CENTER[1] + (Math.random() - 0.5) * 0.02)]; const el = document.createElement('div'); el.className = 'driver-marker'; const m = new mapboxgl.Marker({ element: el, rotationAlignment: 'map' }).setLngLat(coord).addTo(map); nearbyDrivers.push(m); } }
                function clearNearbyDrivers() { for (const m of nearbyDrivers) { try { m.remove(); } catch {} } nearbyDrivers = []; }
                async function showEstimatedRouteAndInfo() { if (!userLocation || !destinationLocation) return; const data = await getRouteData(userLocation, destinationLocation); if (!data) { (tg.showAlert ? tg.showAlert : alert)('Не удалось рассчитать маршрут.'); return; } estimatedDuration = data.duration / 60; estimatedDistance = data.distance / 1000; surgeMult = getSurgeMultiplier(); const prices = computeAllTariffs(estimatedDistance, estimatedDuration, surgeMult, promo); priceEconomy.textContent = `~${prices.economy}₽`; priceComfort.textContent = `~${prices.comfort}₽`; priceVan.textContent = `~${prices.van}₽`; calculatedPrice = prices[currentTariff]; estimatedTimeEl.textContent = `Время в пути: ${Math.ceil(estimatedDuration)} мин`; estimatedDistanceEl.textContent = `Расстояние: ${estimatedDistance.toFixed(1)} км`; estimatedPriceEl.textContent = `Стоимость: ${calculatedPrice}₽`; surgeBadge.classList.toggle('hidden', surgeMult <= 1.01); tripInfoDiv.classList.remove('hidden'); const geojson = { type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: data.geometry.coordinates } }; layerStore.estimated = geojson; addRouteLayer('estimated-route', geojson, '#9ca3af', 4, 0.55, [2, 2]); fitToCoordinates(data.geometry.coordinates, { bottom: 260 }); }
                function getRouteData(start, end) { if (routeAbortController) routeAbortController.abort(); routeAbortController = new AbortController(); const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start.join(',')};${end.join(',')}?steps=false&geometries=geojson&access_token=${mapboxgl.accessToken}`; return fetch(url, { signal: routeAbortController.signal }) .then(res => { if (!res.ok) throw new Error('Network'); return res.json(); }) .then(d => d.routes?.[0] || null) .catch(e => { if (e.name !== 'AbortError') console.error(e); return null; }) .finally(() => { routeAbortController = null; }); }
                function computeAllTariffs(km, min, mult, promoCode) { const calc = (t) => { const base = t.base + t.perKm * km + t.perMin * min; let price = Math.max(t.minFare, base) * (mult || 1); if (promoCode) price = applyPromo(price, promoCode); return Math.round(price); }; return { economy: calc(TARIFFS.economy), comfort: calc(TARIFFS.comfort), van: calc(TARIFFS.van) }; }
                function getSurgeMultiplier() { const h = new Date().getHours(); for (const rule of SURGE_RULES) { if (h >= rule.hours[0] && h < rule.hours[1]) return rule.mult; } return 1; }
                function applyPromo(price, code) { const c = String(code || '').trim().toUpperCase(); if (!c) return price; if (c === 'WELCOME50') return Math.max(0, price - 50); if (c === 'SALE10') return Math.round(price * 0.9); return price; }
                function addRouteLayer(id, geojson, color, width, opacity, dasharray) { removeRouteLayer(id); if (!map || !map.isStyleLoaded()) return; if (!map.getSource(id)) map.addSource(id, { type: 'geojson', data: geojson }); else map.getSource(id).setData(geojson); const paint = { 'line-color': color, 'line-width': width, 'line-opacity': opacity }; if (dasharray) paint['line-dasharray'] = dasharray; if (!map.getLayer(id)) { map.addLayer({ id, type: 'line', source: id, layout: { 'line-join': 'round', 'line-cap': 'round' }, paint }); } }
                function removeRouteLayer(id) { if (!map) return; try { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); } catch {} }
                function fitToCoordinates(coords, extraPadding = {}) { if (!coords || coords.length === 0) return; let b = new mapboxgl.LngLatBounds(coords[0], coords[0]); for (const c of coords) b = b.extend(c); const padding = Object.assign({ top: 40, bottom: 80, left: 40, right: 40 }, extraPadding); map.fitBounds(b, { padding, duration: 700 }); }
                function readdAllLayers() { if (layerStore.estimated) addRouteLayer('estimated-route', layerStore.estimated, '#9ca3af', 4, 0.55, [2,2]); if (layerStore.active) addRouteLayer('route', layerStore.active, getComputedStyle(document.documentElement).getPropertyValue('--tg-accent-color').trim() || '#3887be', 5, 0.8); if (layerStore.history) addRouteLayer('history-route', layerStore.history, '#9ca3af', 5, 0.8); }
                function switchState(newState) { currentAppState = newState; Object.values(states).forEach(s => s.classList.add('hidden')); if (states[newState]) states[newState].classList.remove('hidden'); updateMainButton(); }
                function updateMainButton() { if (!tg.MainButton) return; switch (currentAppState) { case 'addressSelection': if (userLocation && destinationLocation) { tg.MainButton.setText(`Заказать такси (${calculatedPrice}₽)`); tg.MainButton.setParams({ color: tg.themeParams?.button_color || '#2481cc' }); tg.MainButton.show(); tg.MainButton.enable(); } else tg.MainButton.hide(); break; case 'searching': tg.MainButton.setText(`Отменить`); tg.MainButton.setParams({ color: '#ef4444' }); tg.MainButton.show(); tg.MainButton.enable(); startCancellationTimer(); break; case 'trip': tg.MainButton.hide(); break; case 'finished': tg.MainButton.setText('Заказать новую поездку'); tg.MainButton.setParams({ color: tg.themeParams?.button_color || '#2481cc' }); tg.MainButton.show(); tg.MainButton.enable(); break; } }
                function onMainButtonClick() { if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); switch (currentAppState) { case 'addressSelection': tg.showConfirm ? tg.showConfirm(`Подтверждаете заказ за ${calculatedPrice}₽?`, (ok) => ok && proceedOrder()) : proceedOrder(); break; case 'searching': clearInterval(cancelTimerInterval); clearTimeout(findDriverTimeout); resetToSelection(); if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning'); break; case 'finished': resetToSelection(); break; } }
                function onBackButton() { const anyModalOpen = document.querySelector('.modal-content.active'); if (anyModalOpen) { closeModal(); return; } if (pickOnMapMode) { setPickOnMapMode(false); return; } if (currentAppState === 'trip' || currentAppState === 'searching') { tg.showConfirm && tg.showConfirm('Отменить текущую поездку?', (ok) => { if (ok) resetToSelection(); }); } else if (currentAppState === 'finished') { resetToSelection(); } else { tg.close && tg.close(); } }
                function proceedOrder() { switchState('searching'); removeRouteLayer('estimated-route'); layerStore.estimated = null; const order = { type: 'ride_order', tariff: currentTariff, payment, promo: promo || null, pickup: { lng: userLocation?.[0], lat: userLocation?.[1], placeName: fromAddressText }, dropoff: { lng: destinationLocation?.[0], lat: destinationLocation?.[1], placeName: toAddressText }, distance_km: Number(estimatedDistance.toFixed(2)), duration_min: Math.round(estimatedDuration), surge: surgeMult, price: calculatedPrice, client_ts: Date.now() }; try { tg.sendData && tg.sendData(JSON.stringify(order)); } catch {} const randomDelay = 3000 + Math.random() * 5000; findDriverTimeout = setTimeout(startTripSimulation, randomDelay); }
                function startCancellationTimer() { if (!tg.MainButton) return; let timeLeft = 60; const update = () => tg.MainButton.setText(`Отменить (${timeLeft}с)`); clearInterval(cancelTimerInterval); update(); cancelTimerInterval = setInterval(() => { timeLeft--; update(); if (timeLeft <= 0) { clearInterval(cancelTimerInterval); tg.MainButton.hide(); tg.MainButton.disable(); } }, 1000); }
                function startTripSimulation() { switchState('trip'); const driver = FAKE_DRIVERS[Math.floor(Math.random() * FAKE_DRIVERS.length)]; const plate = `${'АВЕКМНОРСТУХ'[Math.floor(Math.random()*12)]}${100+Math.floor(Math.random()*900)}${'АВЕКМНОРСТУХ'[Math.floor(Math.random()*12)]}${'АВЕКМНОРСТУХ'[Math.floor(Math.random()*12)]} 12`; driverInfoEl.textContent = `${driver.name} • ${driver.model}, ${plate}`; carInfoEl.textContent = `${driver.color} цвет`; clearNearbyDrivers(); const driverStart = [(userLocation || CITY_CENTER)[0] + (Math.random() - 0.5) * 0.02, (userLocation || CITY_CENTER)[1] + (Math.random() - 0.5) * 0.02]; const el = document.createElement('div'); el.className = 'driver-marker'; driverMarker = new mapboxgl.Marker({ element: el, rotationAlignment: 'map' }).setLngLat(driverStart).addTo(map); tripStatusText.textContent = 'Водитель подъезжает'; getRouteAndAnimate(driverStart, userLocation, 'pickup', () => { tripStatusText.textContent = 'Водитель ожидает'; driverEtaEl.textContent = 'Пожалуйста, выходите'; tg.HapticFeedback && tg.HapticFeedback.notificationOccurred('success'); setTimeout(() => { tripStatusText.textContent = 'В пути'; getRouteAndAnimate(userLocation, destinationLocation, 'dropoff', (finalGeoJSON) => { switchState('finished'); const payText = (payment === 'cash') ? 'наличными' : 'картой'; finalPriceEl.textContent = `${calculatedPrice}₽ ${payText}`; currentTripId = Date.now(); saveTrip({ id: currentTripId, from: fromAddressText, to: toAddressText, driver: `${driver.name} • ${driver.model}, ${plate}`, color: driver.color, route: finalGeoJSON, date: new Date().toLocaleString('ru-RU'), distance: estimatedDistance.toFixed(1), duration: Math.ceil(estimatedDuration), price: calculatedPrice, rating: 0 }); tg.HapticFeedback && tg.HapticFeedback.notificationOccurred('success'); if (driverMarker) { driverMarker.remove(); driverMarker = null; } }); }, 4000); }); }
                function getRouteAndAnimate(start, end, phase, onComplete) { if (animationFrameId) cancelAnimationFrame(animationFrameId); getRouteData(start, end).then(routeData => { if (!routeData?.geometry?.coordinates || routeData.geometry.coordinates.length < 2) { (tg.showAlert ? tg.showAlert : alert)('Ошибка построения маршрута.'); resetToSelection(); return; } const coords = routeData.geometry.coordinates; const durationSec = routeData.duration; const geojson = { type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: coords } }; layerStore.active = geojson; addRouteLayer('route', geojson, getComputedStyle(document.documentElement).getPropertyValue('--tg-accent-color').trim() || '#3887be', 5, 0.8); fitToCoordinates(coords, { bottom: 260 }); animateAlong(coords, durationSec, () => onComplete && onComplete(geojson), phase); }); }
                function animateAlong(route, durationSec, done, phase) { if (!route || route.length < 2) { done && done(); return; } const line = turf.lineString(route); const dist = turf.length(line, { units: 'kilometers' }); const speedUp = 3; let startTime = performance.now(); function frame(ts) { const t = Math.min(1, (ts - startTime) / (durationSec * 1000 / speedUp)); const curPoint = turf.along(line, dist * t, { units: 'kilometers' }); const cur = curPoint.geometry.coordinates; const ahead = turf.along(line, dist * Math.min(t + 0.001, 1), { units: 'kilometers' }); const bearing = turf.bearing(curPoint, ahead); if (driverMarker) { driverMarker.setLngLat(cur); if (!isNaN(bearing)) { driverMarker.setRotationAlignment('map'); if (typeof driverMarker.setRotation === 'function') driverMarker.setRotation(bearing); } } const etaMin = Math.ceil(((1 - t) * durationSec) / 60 / speedUp); driverEtaEl.textContent = etaMin > 0 ? `Прибытие через ${etaMin} мин` : 'Прибыли'; if (phase === 'dropoff') map.panTo(cur, { duration: 200 }); if (t >= 1) { cancelAnimationFrame(animationFrameId); done && done(); return; } animationFrameId = requestAnimationFrame(frame); } if (animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = requestAnimationFrame(frame); }
                function loadPersistedData() { const apply = (data) => { try { presets.home = data.preset_home ? JSON.parse(data.preset_home) : null; presets.work = data.preset_work ? JSON.parse(data.preset_work) : null; } catch {} try { recents = data.recents ? JSON.parse(data.recents) : (JSON.parse(localStorage.getItem('recents') || '[]')); } catch { recents = []; } try { tripHistory = data.trip_history ? JSON.parse(data.trip_history) : (JSON.parse(localStorage.getItem('trip_history') || '[]')); } catch { tripHistory = []; } try { const p = data.payment ? JSON.parse(data.payment) : (localStorage.getItem('payment')); payment = (p === 'card' || p === 'cash') ? p : payment; } catch {} try { const t = data.tariff ? JSON.parse(data.tariff) : (localStorage.getItem('tariff')); currentTariff = (t && TARIFFS[t]) ? t : currentTariff; } catch {} try { promo = data.promo ? JSON.parse(data.promo) : (localStorage.getItem('promo') || null); } catch {} }; if (tg.CloudStorage) { tg.CloudStorage.getItems(['preset_home','preset_work','recents','trip_history','payment','tariff','promo'], (err, data) => { if (err || !data) { apply({ preset_home: localStorage.getItem('preset_home'), preset_work: localStorage.getItem('preset_work'), recents: localStorage.getItem('recents'), trip_history: localStorage.getItem('trip_history'), payment: localStorage.getItem('payment'), tariff: localStorage.getItem('tariff'), promo: localStorage.getItem('promo') }); } else apply(data); }); } else { apply({ preset_home: localStorage.getItem('preset_home'), preset_work: localStorage.getItem('preset_work'), recents: localStorage.getItem('recents'), trip_history: localStorage.getItem('trip_history'), payment: localStorage.getItem('payment'), tariff: localStorage.getItem('tariff'), promo: localStorage.getItem('promo') }); } }
                function persist(key, value) { const str = JSON.stringify(value); if (tg.CloudStorage) tg.CloudStorage.setItem(key, str, () => {}); try { localStorage.setItem(key, str); } catch {} }
                function saveTrip(trip) { const idx = tripHistory.findIndex(t => t.id === trip.id); if (idx !== -1) tripHistory[idx] = trip; else { tripHistory.unshift(trip); if (tripHistory.length > 20) tripHistory.pop(); } persist('trip_history', tripHistory); }
                function renderHistory() { const listEl = document.getElementById('history-list'); listEl.innerHTML = (tripHistory.length === 0) ? `<p style="color: var(--tg-hint-color);">У вас пока нет поездок.</p>` : tripHistory.map(trip => ` <div class="p-3 rounded-lg cursor-pointer hover:opacity-80" style="background-color: var(--tg-secondary-bg-color);" data-route='${encodeURIComponent(JSON.stringify(trip.route))}' data-id='${trip.id}'> <p class="font-semibold truncate" style="color: var(--tg-text-color);">Куда: ${escapeHtml(trip.to.split(',')[0])}</p> <p class="text-sm truncate" style="color: var(--tg-hint-color);">Откуда: ${escapeHtml(trip.from.split(',')[0])}</p> <p class="text-xs mt-1" style="color: var(--tg-hint-color);">${escapeHtml(trip.driver)} • ${escapeHtml(trip.date)}</p> <p class="text-xs" style="color: var(--tg-hint-color);">Расстояние: ${trip.distance} км • Время: ${trip.duration} мин • Цена: ${trip.price}₽ • Оценка: ${trip.rating || '—'}</p> <div class="mt-2 flex gap-2"> <button class="px-2 py-1 text-xs rounded" data-repeat="${trip.id}" style="background-color: var(--tg-button-color); color: var(--tg-button-text-color);">Повторить</button> <button class="px-2 py-1 text-xs rounded" data-show="${trip.id}" style="background-color: var(--tg-secondary-bg-color);">Маршрут</button> </div> </div> `).join(''); listEl.querySelectorAll('[data-show]').forEach(btn => { btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.show; const trip = tripHistory.find(t => String(t.id) === String(id)); if (trip && trip.route) { showHistoryRoute(trip.route); closeModal(); } }); }); listEl.querySelectorAll('[data-repeat]').forEach(btn => { btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.repeat; const trip = tripHistory.find(t => String(t.id) === String(id)); if (trip && trip.route?.geometry?.coordinates?.length) { const last = trip.route.geometry.coordinates.at(-1); destinationLocation = last; toAddressText = trip.to || 'Пункт назначения'; geocoder && geocoder.setInput(toAddressText); showEstimatedRouteAndInfo(); closeModal(); } }); }); }
                function showHistoryRoute(routeGeoJSON) { removeRouteLayer('route'); layerStore.active = null; removeRouteLayer('estimated-route'); layerStore.estimated = null; removeRouteLayer('history-route'); layerStore.history = routeGeoJSON; addRouteLayer('history-route', routeGeoJSON, '#9ca3af', 5, 0.85); fitToCoordinates(routeGeoJSON.geometry.coordinates, { bottom: 80 }); }
                function renderProfile() { const user = tg?.initDataUnsafe?.user; document.getElementById('profile-name').textContent = (user) ? `${user.first_name || ''} ${user.last_name || ''}`.trim() : 'Гость'; document.getElementById('profile-username').textContent = (user?.username) ? `@${user.username}` : 'Username не указан'; }
                function openModal(modal) { modal.classList.add('active'); modalOverlay.classList.add('active'); tg.BackButton && tg.BackButton.show(); }
                function closeModal() { document.querySelectorAll('.modal-content.active').forEach(m => m.classList.remove('active')); modalOverlay.classList.remove('active'); tg.BackButton && tg.BackButton.hide(); removeRouteLayer('history-route'); layerStore.history = null; }
                function resetToSelection() { if (animationFrameId) cancelAnimationFrame(animationFrameId); if (findDriverTimeout) clearTimeout(findDriverTimeout); if (cancelTimerInterval) clearInterval(cancelTimerInterval); removeRouteLayer('route'); layerStore.active = null; removeRouteLayer('estimated-route'); layerStore.estimated = null; removeRouteLayer('history-route'); layerStore.history = null; if (driverMarker) { driverMarker.remove(); driverMarker = null; } geocoder && geocoder.clear(); destinationLocation = null; tripInfoDiv.classList.add('hidden'); selectedRating = 0; ratingStars.forEach(s => { s.classList.remove('selected'); s.style.color = ''; }); placeNearbyDrivers(); if (userLocation) { map.flyTo({ center: userLocation, zoom: 15 }); setOrMoveUserMarker(userLocation); } switchState('addressSelection'); }
                function escapeHtml(s) { return String(s || '').replace(/[&<>"'`=\/]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' }[c])); }
                function pushRecent(place) { if (!place?.lng || !place?.lat) return; recents = recents.filter(r => Math.abs(r.lng - place.lng) > 1e-6 || Math.abs(r.lat - place.lat) > 1e-6); recents.push({ ...place, ts: Date.now() }); recents = recents.slice(-10); persist('recents', recents); }
                function showRecents() { if (!recents.length) { (tg.showAlert ? tg.showAlert : alert)('Недавних адресов пока нет'); return; } const items = recents.slice().reverse().slice(0, 8).map((r, i) => `${i+1}. ${r.placeName}`).join('\n'); tg.showPopup ? tg.showPopup({ title: 'Недавние', message: items, buttons: [{type:'ok'}] }) : alert('Недавние:\n' + items); }
                function setPreset(kind) { const p = presets[kind]; if (p) { destinationLocation = [p.lng, p.lat]; toAddressText = p.placeName || (kind === 'home' ? 'Дом' : 'Работа'); geocoder && geocoder.setInput(toAddressText); showEstimatedRouteAndInfo(); return; } const ask = (m, cb) => tg.showConfirm ? tg.showConfirm(m, (ok) => cb(ok)) : cb(confirm(m)); ask(`Сохранить текущее местоположение как «${kind === 'home' ? 'Дом' : 'Работа'}»?`, async (ok) => { if (!ok) return; try { const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 })); const lng = pos.coords.longitude, lat = pos.coords.latitude; const placeName = await reverseGeocode([lng, lat]) || (kind === 'home' ? 'Дом' : 'Работа'); presets[kind] = { lng, lat, placeName }; persist('preset_' + kind, presets[kind]); tg.showAlert && tg.showAlert('Сохранено'); } catch { tg.showAlert && tg.showAlert('Не удалось получить геопозицию'); } }); }
                function setPickOnMapMode(enabled) { pickOnMapMode = !!enabled; btnPickOnMap.textContent = enabled ? 'Готово' : 'Указать'; tg.HapticFeedback && (enabled ? tg.HapticFeedback.impactOccurred('light') : tg.HapticFeedback.selectionChanged()); }
                function updatePaymentBadge() { payBadge.textContent = 'Оплата: ' + (payment === 'cash' ? 'Наличные' : 'Карта'); }
                function updateTariffUI() { const accent = getComputedStyle(document.documentElement).getPropertyValue('--tg-accent-color') || '#3887be'; const border = '1px solid ' + (getComputedStyle(document.documentElement).getPropertyValue('--tg-hint-color') || '#999'); const setSel = (el, sel) => { el.style.border = sel ? `2px solid ${accent.trim()}` : border; }; setSel(tileEconomy, currentTariff === 'economy'); setSel(tileComfort, currentTariff === 'comfort'); setSel(tileVan, currentTariff === 'van'); }
                function recalcPricesIfNeeded() { if (estimatedDistance > 0 && estimatedDuration > 0) { const prices = computeAllTariffs(estimatedDistance, estimatedDuration, surgeMult, promo); priceEconomy.textContent = `~${prices.economy}₽`; priceComfort.textContent = `~${prices.comfort}₽`; priceVan.textContent = `~${prices.van}₽`; calculatedPrice = prices[currentTariff]; estimatedPriceEl.textContent = `Стоимость: ${calculatedPrice}₽`; updateMainButton(); } }
                function askPromo() { const code = prompt('Введите промокод:') || ''; if (!code.trim()) return; promo = code.trim(); persist('promo', promo); recalcPricesIfNeeded(); tg.HapticFeedback && tg.HapticFeedback.notificationOccurred('success'); }
                historyBtn.addEventListener('click', () => { renderHistory(); openModal(historyModal); });
                profileBtn.addEventListener('click', () => { renderProfile(); openModal(profileModal); });
                modalOverlay.addEventListener('click', closeModal);
                btnMyLocation.addEventListener('click', async () => { try { const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 })); userLocation = [pos.coords.longitude, pos.coords.latitude]; setOrMoveUserMarker(userLocation); map.easeTo({ center: userLocation, zoom: 15 }); const name = await reverseGeocode(userLocation); fromAddressText = name || 'Ваше местоположение'; fromAddressEl.textContent = fromAddressText; geocoder.setProximity({ longitude: userLocation[0], latitude: userLocation[1] }); if (destinationLocation) showEstimatedRouteAndInfo(); } catch { (tg.showAlert ? tg.showAlert : alert)('Не удалось получить геопозицию'); } });
                btnPickOnMap.addEventListener('click', () => setPickOnMapMode(!pickOnMapMode));
                chipHome.addEventListener('click', () => setPreset('home'));
                chipWork.addEventListener('click', () => setPreset('work'));
                chipRecent.addEventListener('click', showRecents);
                payBadge.addEventListener('click', () => { payment = (payment === 'cash') ? 'card' : 'cash'; updatePaymentBadge(); persist('payment', payment); tg.HapticFeedback && tg.HapticFeedback.selectionChanged(); });
                promoBtn.addEventListener('click', askPromo);
                tileEconomy.addEventListener('click', () => { currentTariff = 'economy'; updateTariffUI(); persist('tariff', currentTariff); recalcPricesIfNeeded(); tg.HapticFeedback && tg.HapticFeedback.selectionChanged(); });
                tileComfort.addEventListener('click', () => { currentTariff = 'comfort'; updateTariffUI(); persist('tariff', currentTariff); recalcPricesIfNeeded(); tg.HapticFeedback && tg.HapticFeedback.selectionChanged(); });
                tileVan.addEventListener('click', () => { currentTariff = 'van'; updateTariffUI(); persist('tariff', currentTariff); recalcPricesIfNeeded(); tg.HapticFeedback && tg.HapticFeedback.selectionChanged(); });
                callDriverBtn.addEventListener('click', () => { tg.HapticFeedback && tg.HapticFeedback.impactOccurred('light'); (tg.showAlert ? tg.showAlert : alert)('Звонок водителю (симуляция)'); });
                shareTripBtn.addEventListener('click', () => { const text = `Еду: ${fromAddressText} → ${toAddressText} • цена ~${calculatedPrice}₽ • ETA ~${Math.ceil(estimatedDuration)} мин`; const url = 'https://t.me/share/url?text=' + encodeURIComponent(text); tg.openTelegramLink ? tg.openTelegramLink(url) : window.open(url, '_blank'); });
                safetyBtn.addEventListener('click', () => { const message = 'В экстренной ситуации звоните 112.\nСлужба поддержки: @support'; tg.showPopup ? tg.showPopup({ title: 'Безопасность', message, buttons:[{type:'ok'}] }) : alert(message); });
                ratingStars.forEach(star => { star.addEventListener('click', () => { selectedRating = parseInt(star.dataset.rating); ratingStars.forEach(s => { const on = parseInt(s.dataset.rating) <= selectedRating; s.classList.toggle('selected', on); s.style.color = on ? '#fbbf24' : ''; }); const trip = tripHistory.find(t => t.id === currentTripId); if (trip) { trip.rating = selectedRating; saveTrip(trip); } tg.HapticFeedback && tg.HapticFeedback.notificationOccurred('success'); }); });
            })();
        }
    </script>
</body>
</html>

