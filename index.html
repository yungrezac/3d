<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Такси</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Mapbox Geocoder Plugin -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            width: 100%;
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #111827);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        /* Стили для модального окна */
        #bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        #bottom-sheet.is-open {
            transform: translateY(0);
        }
        /* Кастомизация геокодера Mapbox */
        .mapboxgl-ctrl-geocoder {
            box-shadow: none;
            width: 100%;
            max-width: none;
            background-color: transparent;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 48px;
            padding-left: 10px;
            font-size: 1rem;
            background-color: #f3f4f6; /* Светло-серый фон поля */
            border-radius: 0.75rem;
        }
        .mapboxgl-ctrl-geocoder--input:focus {
            outline: 2px solid var(--tg-theme-button-color, #2481cc);
        }
    </style>
</head>
<body>

    <!-- Карта на весь экран -->
    <div id="map"></div>

    <!-- Панель с кнопками выбора адреса -->
    <div id="controls" class="fixed bottom-0 left-0 w-full p-4 bg-[var(--tg-theme-secondary-bg-color,#ffffff)] rounded-t-2xl shadow-lg space-y-3">
        <button id="from-btn" class="w-full text-left flex items-center p-3 bg-gray-100 rounded-lg">
            <span class="flex-shrink-0 w-6 text-center text-green-500"><i class="fas fa-map-marker-alt"></i></span>
            <span id="from-text" class="ml-3 truncate text-gray-500">Откуда?</span>
        </button>
        <button id="to-btn" class="w-full text-left flex items-center p-3 bg-gray-100 rounded-lg">
            <span class="flex-shrink-0 w-6 text-center text-red-500"><i class="fas fa-flag-checkered"></i></span>
            <span id="to-text" class="ml-3 truncate text-gray-500">Куда?</span>
        </button>
    </div>

    <!-- Модальное окно (Bottom Sheet) для поиска -->
    <div id="bottom-sheet" class="fixed bottom-0 left-0 w-full h-[90vh] bg-[var(--tg-theme-secondary-bg-color,#ffffff)] rounded-t-2xl shadow-2xl flex flex-col z-20">
        <div class="p-4 flex-shrink-0">
            <!-- Ручка для перетаскивания (декоративная) -->
            <div class="w-10 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
            <h3 id="sheet-title" class="text-xl font-bold text-center">Укажите адрес</h3>
        </div>
        <div id="geocoder-container" class="px-4"></div>
        <!-- Здесь можно будет добавить список результатов или избранные адреса -->
    </div>
    
    <!-- Оверлей для затемнения фона -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-10 hidden"></div>

    <!-- Экран поиска -->
    <div id="searching-screen" class="hidden fixed inset-0 bg-white bg-opacity-90 flex-grow flex flex-col items-center justify-center text-center z-30">
        <div class="relative w-32 h-32">
            <div class="absolute inset-0 border-4 border-amber-400 rounded-full animate-ping"></div>
            <div class="w-full h-full bg-amber-400 rounded-full flex items-center justify-center">
                <i class="fas fa-taxi text-5xl text-white"></i>
            </div>
        </div>
        <h2 class="text-2xl font-bold mt-8">Ищем водителя...</h2>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // --- Конфигурация Mapbox ---
            const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk-9cXjfReUGLGnNkm6Q';
            mapboxgl.accessToken = MAPBOX_TOKEN;
            const KOZMODEMYANSK_CENTER = [46.5704, 56.3339]; 
            const KOZMODEMYANSK_BBOX = [46.45, 56.29, 46.69, 56.37];

            // --- UI Элементы ---
            const bottomSheet = document.getElementById('bottom-sheet');
            const sheetTitle = document.getElementById('sheet-title');
            const overlay = document.getElementById('overlay');
            const fromBtn = document.getElementById('from-btn');
            const toBtn = document.getElementById('to-btn');
            const fromText = document.getElementById('from-text');
            const toText = document.getElementById('to-text');
            const searchingScreen = document.getElementById('searching-screen');

            // --- Переменные состояния ---
            let map, geocoder, markerFrom, markerTo;
            let currentSearchContext = null; // 'from' или 'to'
            let orderData = { from: null, to: null };

            // 1. Инициализация приложения
            tg.ready();
            tg.expand();

            // 2. Инициализация карты
            initializeMap();

            // --- Функции управления модальным окном ---
            function openSheet(context) {
                currentSearchContext = context;
                sheetTitle.textContent = context === 'from' ? 'Укажите место отправления' : 'Куда поедете?';
                bottomSheet.classList.add('is-open');
                overlay.classList.remove('hidden');
                geocoder.clear();
                // Фокус на поле ввода с небольшой задержкой для плавной анимации
                setTimeout(() => document.querySelector('.mapboxgl-ctrl-geocoder--input').focus(), 300);
            }

            function closeSheet() {
                bottomSheet.classList.remove('is-open');
                overlay.classList.add('hidden');
                document.querySelector('.mapboxgl-ctrl-geocoder--input').blur();
            }
            
            // --- Форматирование адреса ---
            function formatAddress(feature) {
                const houseNumber = feature.address;
                const street = feature.text;
                if (street && houseNumber && street.includes(houseNumber)) return street;
                if (street && houseNumber) return `${street}, ${houseNumber}`;
                return street || feature.place_name.split(',')[0];
            }

            // --- Инициализация карты и геокодера ---
            function initializeMap() {
                map = new mapboxgl.Map({
                    container: 'map', style: 'mapbox://styles/mapbox/streets-v12',
                    center: KOZMODEMYANSK_CENTER, zoom: 13
                });

                geocoder = new MapboxGeocoder({
                    accessToken: MAPBOX_TOKEN, mapboxgl: mapboxgl, marker: false,
                    bbox: KOZMODEMYANSK_BBOX, language: 'ru-RU', country: 'RU',
                    placeholder: "Введите улицу и номер дома"
                });
                
                document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));
                
                markerFrom = new mapboxgl.Marker({ color: '#16a34a' });
                markerTo = new mapboxgl.Marker({ color: '#dc2626' });

                geocoder.on('result', (event) => handleAddressSelection(event.result));
                
                map.on('click', handleMapClick);
            }
            
            function handleMapClick(e) {
                const context = orderData.from ? 'to' : 'from';
                reverseGeocode(e.lngLat.toArray(), context);
            }
            
            async function reverseGeocode(coords, context) {
                 const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?types=address,poi&access_token=${MAPBOX_TOKEN}&language=ru-RU`);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                   handleAddressSelection(data.features[0]);
                }
            }
            
            function handleAddressSelection(feature) {
                const context = currentSearchContext || (orderData.from ? 'to' : 'from');
                const address = formatAddress(feature);
                const coords = feature.geometry.coordinates;

                const textElement = context === 'from' ? fromText : toText;
                const marker = context === 'from' ? markerFrom : markerTo;

                textElement.textContent = address;
                textElement.classList.remove('text-gray-500');
                
                marker.setLngLat(coords).addTo(map);

                orderData[context] = { address, coords };

                closeSheet();
                checkOrderReady();
                map.flyTo({ center: coords, zoom: 15 });
            }

            // --- Проверка готовности заказа и управление главной кнопкой ---
            function checkOrderReady() {
                if (orderData.from && orderData.to) {
                    tg.MainButton.setText('Найти водителя');
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }

            // --- Обработчики событий ---
            fromBtn.addEventListener('click', () => openSheet('from'));
            toBtn.addEventListener('click', () => openSheet('to'));
            overlay.addEventListener('click', closeSheet);
            
            tg.onEvent('mainButtonClicked', () => {
                const finalData = {
                    queryId: tg.initDataUnsafe?.query_id, user: tg.initDataUnsafe?.user,
                    order: {
                        from: { address: orderData.from.address, coords: orderData.from.coords },
                        to: { address: orderData.to.address, coords: orderData.to.coords },
                    }
                };
                tg.sendData(JSON.stringify(finalData));
                searchingScreen.classList.remove('hidden');
                tg.MainButton.hide();
            });
        });
    </script>
</body>
</html>

