<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Такси</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- FIX: Replaced Mapbox GL JS with Leaflet.js to solve cross-origin errors -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            width: 100%;
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #111827);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 0;
        }
        #bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 20;
        }
        #bottom-sheet.is-open {
            transform: translateY(0);
        }
        .address-btn {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
            transition: all 0.2s ease-in-out;
        }
        .address-text.placeholder {
            color: var(--tg-theme-hint-color, #9ca3af);
        }
        .address-text.filled {
            color: var(--tg-theme-text-color, #111827);
            font-weight: 500;
        }
        .clear-btn {
            display: none;
        }
        .filled ~ .clear-btn {
            display: block;
        }
        /* New styles for geocoder input and results */
        #geocoder-input {
            height: 48px;
            padding-left: 10px;
            font-size: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            width: 100%;
            border: 2px solid transparent;
        }
        #geocoder-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }
        #geocoder-results {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
        }
        .leaflet-control-attribution, .leaflet-control-zoom {
            z-index: 1;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="controls" class="fixed bottom-0 left-0 w-full p-4 bg-[var(--tg-theme-secondary-bg-color,#ffffff)] rounded-t-2xl shadow-lg space-y-3 border-t border-gray-200 z-10">
        <div class="relative flex items-center">
            <button id="from-btn" class="address-btn w-full text-left flex items-center p-3 rounded-xl">
                <span class="flex-shrink-0 w-6 text-center text-green-500"><i class="fas fa-map-marker-alt"></i></span>
                <span id="from-text" class="address-text placeholder ml-3 truncate">Откуда?</span>
            </button>
            <button id="from-clear-btn" class="clear-btn absolute right-3 p-1 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times-circle"></i>
            </button>
        </div>
        <div class="relative flex items-center">
            <button id="to-btn" class="address-btn w-full text-left flex items-center p-3 rounded-xl">
                <span class="flex-shrink-0 w-6 text-center text-red-500"><i class="fas fa-flag-checkered"></i></span>
                <span id="to-text" class="address-text placeholder ml-3 truncate">Куда?</span>
            </button>
            <button id="to-clear-btn" class="clear-btn absolute right-3 p-1 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times-circle"></i>
            </button>
        </div>
    </div>

    <div id="bottom-sheet" class="fixed bottom-0 left-0 w-full h-[90vh] bg-[var(--tg-theme-secondary-bg-color,#ffffff)] rounded-t-2xl shadow-2xl flex flex-col">
        <div class="p-4 flex-shrink-0">
            <div class="w-10 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
            <h3 id="sheet-title" class="text-xl font-bold text-center">Укажите адрес</h3>
        </div>
        <div class="px-4 pb-4 flex-shrink-0">
             <input type="text" id="geocoder-input" placeholder="Введите улицу и номер дома">
        </div>
        <div id="geocoder-results" class="flex-grow overflow-y-auto px-4"></div>
    </div>
    
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-10 hidden"></div>

    <div id="searching-screen" class="hidden fixed inset-0 bg-white bg-opacity-90 flex-grow flex flex-col items-center justify-center text-center z-30">
        <div class="relative w-32 h-32">
            <div class="absolute inset-0 border-4 border-amber-400 rounded-full animate-ping"></div>
            <div class="w-full h-full bg-amber-400 rounded-full flex items-center justify-center">
                <i class="fas fa-taxi text-5xl text-white"></i>
            </div>
        </div>
        <h2 class="text-2xl font-bold mt-8">Ищем водителя...</h2>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;

                const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
                const KOZMODEMYANSK_CENTER = [56.3339, 46.5704]; // Lat, Lon for Leaflet
                const KOZMODEMYANSK_BBOX = [46.45, 56.29, 46.69, 56.37]; // Lon, Lat, Lon, Lat

                const bottomSheet = document.getElementById('bottom-sheet');
                const sheetTitle = document.getElementById('sheet-title');
                const overlay = document.getElementById('overlay');
                const fromBtn = document.getElementById('from-btn');
                const toBtn = document.getElementById('to-btn');
                const fromText = document.getElementById('from-text');
                const toText = document.getElementById('to-text');
                const fromClearBtn = document.getElementById('from-clear-btn');
                const toClearBtn = document.getElementById('to-clear-btn');
                const searchingScreen = document.getElementById('searching-screen');
                const geocoderInput = document.getElementById('geocoder-input');
                const geocoderResults = document.getElementById('geocoder-results');

                let map, markerFrom, markerTo;
                let currentSearchContext = null; 
                let orderData = { from: null, to: null };
                let geocodeTimer;

                tg.ready();
                tg.expand();
                initializeMap();

                function openSheet(context) {
                    currentSearchContext = context;
                    sheetTitle.textContent = context === 'from' ? 'Укажите место отправления' : 'Куда поедете?';
                    bottomSheet.classList.add('is-open');
                    overlay.classList.remove('hidden');
                    geocoderInput.value = '';
                    geocoderResults.innerHTML = '';
                    setTimeout(() => geocoderInput.focus(), 300);
                }

                function closeSheet() {
                    bottomSheet.classList.remove('is-open');
                    overlay.classList.add('hidden');
                    geocoderInput.blur();
                    currentSearchContext = null;
                }
                
                function formatAddress(feature) {
                    return feature.place_name.split(',')[0];
                }

                function initializeMap() {
                    map = L.map('map', { zoomControl: false }).setView(KOZMODEMYANSK_CENTER, 13);
                    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
                        attribution: '&copy; <a href="https://www.mapbox.com/about/maps/">Mapbox</a> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        tileSize: 512,
                        zoomOffset: -1,
                    }).addTo(map);

                    const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                    const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                    
                    markerFrom = L.marker([0,0], { icon: greenIcon });
                    markerTo = L.marker([0,0], { icon: redIcon });

                    map.on('click', handleMapClick);
                }
                
                function updateOrderLocation(feature, context) {
                    if (!context) return;

                    const address = formatAddress(feature);
                    const coords = [feature.center[1], feature.center[0]]; // Lat, Lon for Leaflet

                    const textElement = context === 'from' ? fromText : toText;
                    const marker = context === 'from' ? markerFrom : markerTo;

                    textElement.textContent = address;
                    textElement.classList.remove('placeholder');
                    textElement.classList.add('filled');
                    
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map);
                    }
                    marker.setLatLng(coords);

                    orderData[context] = { address, coords };
                    
                    closeSheet();
                    checkOrderReady();
                    map.flyTo(coords, 15);
                }
                
                function clearOrderLocation(context) {
                    if (!context) return;
                    
                    const textElement = context === 'from' ? fromText : toText;
                    const marker = context === 'from' ? markerFrom : markerTo;

                    textElement.textContent = context === 'from' ? 'Откуда?' : 'Куда?';
                    textElement.classList.add('placeholder');
                    textElement.classList.remove('filled');
                    
                    if (map.hasLayer(marker)) {
                        marker.removeFrom(map);
                    }
                    orderData[context] = null;
                    checkOrderReady();
                }

                function handleMapClick(e) {
                    const context = currentSearchContext || (!orderData.from ? 'from' : !orderData.to ? 'to' : null);
                    if (!context) return;
                    reverseGeocode([e.latlng.lng, e.latlng.lat], context);
                }
                
                async function geocode(query) {
                    if (query.length < 3) {
                        geocoderResults.innerHTML = '';
                        return;
                    }
                    const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?bbox=${KOZMODEMYANSK_BBOX.join(',')}&access_token=${MAPBOX_TOKEN}&language=ru-RU&country=RU`);
                    const data = await response.json();
                    displayGeocodeResults(data.features);
                }

                function displayGeocodeResults(features) {
                    geocoderResults.innerHTML = '';
                    features.forEach(feature => {
                        const li = document.createElement('div');
                        li.className = 'p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100';
                        li.textContent = feature.place_name;
                        li.onclick = () => updateOrderLocation(feature, currentSearchContext);
                        geocoderResults.appendChild(li);
                    });
                }

                async function reverseGeocode(coords, context) {
                    try {
                        const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?types=address,poi&access_token=${MAPBOX_TOKEN}&language=ru-RU`);
                        const data = await response.json();
                        if (data.features && data.features.length > 0) {
                           updateOrderLocation(data.features[0], context);
                        }
                    } catch (error) {
                        console.error("Reverse geocoding failed:", error);
                    }
                }
                
                function checkOrderReady() {
                    if (orderData.from && orderData.to) {
                        tg.MainButton.setText('Найти водителя');
                        tg.MainButton.show();
                    } else {
                        tg.MainButton.hide();
                    }
                }

                // Event Listeners
                fromBtn.addEventListener('click', () => openSheet('from'));
                toBtn.addEventListener('click', () => openSheet('to'));
                fromClearBtn.addEventListener('click', (e) => { e.stopPropagation(); clearOrderLocation('from'); });
                toClearBtn.addEventListener('click', (e) => { e.stopPropagation(); clearOrderLocation('to'); });
                overlay.addEventListener('click', closeSheet);

                geocoderInput.addEventListener('input', () => {
                    clearTimeout(geocodeTimer);
                    geocodeTimer = setTimeout(() => geocode(geocoderInput.value), 300);
                });
                
                tg.onEvent('mainButtonClicked', () => {
                    if (!orderData.from || !orderData.to) return;
                    const finalData = {
                        queryId: tg.initDataUnsafe?.query_id, user: tg.initDataUnsafe?.user,
                        order: {
                            from: { address: orderData.from.address, coords: orderData.from.coords },
                            to: { address: orderData.to.address, coords: orderData.to.coords },
                        }
                    };
                    tg.sendData(JSON.stringify(finalData));
                    searchingScreen.classList.remove('hidden');
                    tg.MainButton.hide();
                });

            } catch (e) {
                console.error("Critical Error:", e);
                document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: #111827;"><h1>Произошла ошибка</h1><p>Не удалось запустить приложение. Пожалуйста, попробуйте перезагрузить.</p></div>`;
            }
        });
    </script>
</body>
</html>

