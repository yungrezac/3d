<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Такси</title>
    <!-- Подключаем Tailwind CSS для быстрой стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем SDK Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Стили и скрипты для Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #111827);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .tg-main-button {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        #map {
            width: 100%;
            flex-grow: 1;
            border-radius: 1rem;
        }
        /* Стилизация полей ввода Mapbox Geocoder */
        .mapboxgl-ctrl-geocoder, .mapboxgl-ctrl-geocoder--input {
            width: 100% !important;
            max-width: 100% !important;
            font-size: 1rem !important;
            box-shadow: none !important;
        }
        .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right * {
            display: none; /* Скрываем лишние иконки */
        }
        .mapboxgl-ctrl-geocoder {
             background-color: transparent;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="h-screen w-screen flex flex-col p-4 space-y-4">
        <!-- Приветствие пользователя -->
        <div id="welcome-screen" class="flex-grow flex flex-col justify-center items-center text-center fade-in">
            <i class="fas fa-taxi text-6xl text-amber-400 mb-4"></i>
            <h1 class="text-2xl font-bold">Добро пожаловать в Такси!</h1>
            <p id="user-greeting" class="text-lg mt-2 opacity-80"></p>
            <button id="order-btn" class="mt-8 w-full max-w-sm tg-main-button font-bold py-3 px-4 rounded-xl shadow-lg transform transition-transform hover:scale-105">
                Заказать такси
            </button>
        </div>

        <!-- Экран заказа -->
        <div id="order-screen" class="hidden flex-grow flex flex-col fade-in">
            <div class="flex items-center mb-4">
                 <button id="back-btn" class="mr-3 text-xl opacity-70"><i class="fas fa-arrow-left"></i></button>
                 <h2 class="text-2xl font-bold">Оформление заказа</h2>
            </div>

            <!-- Поля ввода адреса -->
            <div class="bg-[var(--tg-theme-secondary-bg-color,#ffffff)] p-4 rounded-2xl shadow-md space-y-4">
                <div class="relative flex items-center">
                    <span class="text-green-500 mx-3"><i class="fas fa-map-marker-alt"></i></span>
                    <div id="geocoder-from-container" class="w-full"></div>
                </div>
                <div class="relative flex items-center">
                    <span class="text-red-500 mx-3"><i class="fas fa-flag-checkered"></i></span>
                    <div id="geocoder-to-container" class="w-full"></div>
                </div>
            </div>

            <!-- Карта -->
            <div id="map" class="my-4"></div>
        </div>
        
         <!-- Экран поиска -->
        <div id="searching-screen" class="hidden flex-grow flex flex-col items-center justify-center text-center fade-in">
            <div class="relative w-32 h-32">
                <div class="absolute inset-0 border-4 border-amber-400 rounded-full animate-ping"></div>
                <div class="w-full h-full bg-amber-400 rounded-full flex items-center justify-center">
                    <i class="fas fa-taxi text-5xl text-white"></i>
                </div>
            </div>
            <h2 class="text-2xl font-bold mt-8">Ищем водителя...</h2>
            <p class="mt-2 opacity-80">Это может занять несколько минут</p>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // --- Конфигурация Mapbox ---
            const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
            mapboxgl.accessToken = MAPBOX_TOKEN;
            const KOZMODEMYANSK_CENTER = [46.5704, 56.3339]; 
            const KOZMODEMYANSK_BBOX = [46.45, 56.29, 46.69, 56.37];

            // --- Элементы интерфейса ---
            const welcomeScreen = document.getElementById('welcome-screen');
            const orderScreen = document.getElementById('order-screen');
            const searchingScreen = document.getElementById('searching-screen');
            
            const orderBtn = document.getElementById('order-btn');
            const backBtn = document.getElementById('back-btn');
            const userGreeting = document.getElementById('user-greeting');
            
            let map, geocoderFrom, geocoderTo, markerFrom, markerTo;

            // 1. Инициализация приложения
            tg.ready();
            tg.expand();

            if (tg.initDataUnsafe?.user?.first_name) {
                userGreeting.textContent = `Привет, ${tg.initDataUnsafe.user.first_name}!`;
            } else {
                 userGreeting.textContent = 'Готовы ехать?';
            }
            
            // --- Управление экранами ---
            function showScreen(screen) {
                [welcomeScreen, orderScreen, searchingScreen].forEach(s => s.classList.add('hidden'));
                screen.classList.remove('hidden');
                
                if (screen === orderScreen && !map) {
                    initializeMap();
                }
            }

            orderBtn.addEventListener('click', () => {
                showScreen(orderScreen);
                tg.BackButton.show();
                tg.MainButton.setText('Найти водителя');
                tg.MainButton.show();
            });

            backBtn.addEventListener('click', () => {
                showScreen(welcomeScreen);
                tg.MainButton.hide();
                tg.BackButton.hide();
            });
            
            // --- НОВАЯ ФУНКЦИЯ: Форматирование адреса ---
            // Принимает объект feature от Mapbox и возвращает "Улица, номер дома"
            function formatAddress(feature) {
                const houseNumber = feature.address;
                const street = feature.text;

                if (street && houseNumber) {
                    // Проверяем, не содержит ли улица уже номер дома, чтобы избежать дублирования
                    if (street.includes(houseNumber)) {
                        return street;
                    }
                    return `${street}, ${houseNumber}`;
                }
                return street || feature.place_name.split(',')[0]; // Фоллбэк
            }

            // --- Инициализация карты и геокодеров ---
            function initializeMap() {
                map = new mapboxgl.Map({
                    container: 'map', style: 'mapbox://styles/mapbox/streets-v12',
                    center: KOZMODEMYANSK_CENTER, zoom: 13
                });

                const geocoderOptions = {
                    accessToken: MAPBOX_TOKEN, mapboxgl: mapboxgl, marker: false,
                    bbox: KOZMODEMYANSK_BBOX, language: 'ru-RU', country: 'RU'
                };
                
                geocoderFrom = new MapboxGeocoder({ ...geocoderOptions, placeholder: 'Откуда?' });
                document.getElementById('geocoder-from-container').appendChild(geocoderFrom.onAdd(map));
                
                geocoderTo = new MapboxGeocoder({ ...geocoderOptions, placeholder: 'Куда?' });
                document.getElementById('geocoder-to-container').appendChild(geocoderTo.onAdd(map));
                
                markerFrom = new mapboxgl.Marker({ color: '#16a34a', draggable: true });
                markerTo = new mapboxgl.Marker({ color: '#dc2626', draggable: true });
                
                // ИЗМЕНЕНО: Обработчики событий для геокодеров
                geocoderFrom.on('result', (event) => {
                    const feature = event.result;
                    const coords = feature.geometry.coordinates;
                    geocoderFrom.setInput(formatAddress(feature)); // Устанавливаем короткий адрес
                    markerFrom.setLngLat(coords).addTo(map);
                    map.flyTo({ center: coords, zoom: 15 });
                });

                geocoderTo.on('result', (event) => {
                    const feature = event.result;
                    const coords = feature.geometry.coordinates;
                    geocoderTo.setInput(formatAddress(feature)); // Устанавливаем короткий адрес
                    markerTo.setLngLat(coords).addTo(map);
                    map.flyTo({ center: coords, zoom: 15 });
                });

                map.on('click', (e) => {
                    if (!geocoderFrom.getInput()) handleMapClick(e.lngLat, 'from');
                    else handleMapClick(e.lngLat, 'to');
                });
            }

            function handleMapClick(lngLat, type) {
                const coords = [lngLat.lng, lngLat.lat];
                const marker = type === 'from' ? markerFrom : markerTo;
                const geocoder = type === 'from' ? geocoderFrom : geocoderTo;
                
                marker.setLngLat(coords).addTo(map);
                reverseGeocode(coords, geocoder);
            }
            
            // ИЗМЕНЕНО: Функция обратного геокодирования
            async function reverseGeocode(coords, geocoder) {
                // Запрашиваем только адреса (address) или точки интереса (poi) для точности
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?types=address,poi&access_token=${MAPBOX_TOKEN}&language=ru-RU`);
                const data = await response.json();
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    geocoder.setInput(formatAddress(feature)); // Устанавливаем короткий адрес
                }
            }

            // --- Логика главной кнопки ---
            const onMainButtonClick = () => {
                const fromAddress = geocoderFrom.getInput();
                const toAddress = geocoderTo.getInput();

                if (!fromAddress || !toAddress) {
                    tg.showAlert('Пожалуйста, укажите адрес отправления и назначения.');
                    return;
                }
                
                const orderData = {
                    queryId: tg.initDataUnsafe?.query_id, user: tg.initDataUnsafe?.user,
                    order: {
                        from: { address: fromAddress, coords: markerFrom.getLngLat() },
                        to: { address: toAddress, coords: markerTo.getLngLat() },
                    }
                };
                
                tg.sendData(JSON.stringify(orderData));
                
                showScreen(searchingScreen);
                tg.MainButton.hide();
            };

            tg.onEvent('mainButtonClicked', onMainButtonClick);
            tg.BackButton.onClick(() => {
                if (!orderScreen.classList.contains('hidden')) backBtn.click();
            });
        });
    </script>

</body>
</html>

