<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Такси Mini App</title>
    
    <!-- Стили и скрипты -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- НОВОЕ: Скрипты для геокодера (поиск адресов) и маршрутов -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body, html { overscroll-behavior: none; overflow: hidden; height: 100%; width: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .bottom-sheet { touch-action: none; transition: transform 0.3s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Стили для кастомного маркера водителя */
        .driver-marker { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="%233B82F6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>'); background-size: contain; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        /* Стили для геокодера Mapbox */
        .mapboxgl-ctrl-geocoder { width: 100% !important; max-width: none !important; font-size: 1rem; }
        .mapboxgl-ctrl-geocoder--input { height: 48px !important; padding-left: 40px !important; }
        .mapboxgl-ctrl-geocoder--icon-search { top: 12px !important; left: 12px !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="global-loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50 p-4">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-gray-600">Подключаемся...</p>
    </div>

    <div id="app-container" class="relative h-screen w-screen hidden">
        <div id="map" class="absolute inset-0"></div>

        <!-- EKRAN PASSAZHIRA -->
        <div id="passenger-screen" class="hidden">
            <div id="bottom-sheet" class="bottom-sheet absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl p-4 flex flex-col z-10" style="transform: translateY(calc(100% - 290px));">
                <div id="sheet-handle" class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab active:cursor-grabbing"></div>
                <div id="sheet-content">
                    <div id="order-form-state">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Куда поедем?</h2>
                        <div class="space-y-3">
                            <!-- НОВОЕ: Контейнеры для геокодеров -->
                            <div id="from-geocoder" class="relative"></div>
                            <div id="to-geocoder" class="relative"></div>
                        </div>
                        <button id="order-button" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-lg mt-5 hover:bg-blue-700 active:bg-blue-800 transition-colors">Заказать такси</button>
                    </div>
                    <div id="searching-state" class="hidden text-center py-8">
                        <div class="loader mx-auto"></div>
                        <h3 class="text-xl font-semibold mt-4">Ищем машину...</h3>
                        <button id="cancel-search-button" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-lg mt-6 hover:bg-red-700">Отменить поиск</button>
                    </div>
                    <div id="driver-found-state" class="hidden">
                         <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Водитель в пути!</h2>
                         <div class="bg-gray-100 p-3 rounded-lg flex items-center space-x-4">
                             <img id="driver-avatar" src="https://placehold.co/60x60/E2E8F0/A0AEC0?text=A" class="w-14 h-14 rounded-full">
                             <div>
                                 <p id="driver-name" class="font-bold text-lg">Водитель</p>
                                 <p id="driver-car" class="text-gray-600">Машина</p>
                             </div>
                             <div class="flex-grow text-right"><p id="driver-car-plate" class="font-mono bg-white border border-gray-300 px-2 py-1 rounded">A123BC</p></div>
                         </div>
                         <div class="mt-4 text-center"><p id="ride-status-passenger" class="text-lg font-medium text-blue-600">Водитель едет к вам</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EKRAN VODITELYA -->
        <div id="driver-screen" class="hidden w-full h-full flex flex-col p-4 bg-white z-20 absolute inset-0">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Заказы</h1>
                <div class="flex items-center space-x-2">
                    <span id="driver-status-text" class="text-gray-600 font-medium">Офлайн</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="driver-status-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            <div id="active-ride-driver" class="hidden border-2 border-blue-500 rounded-lg p-4 mb-4">
                <h2 class="text-xl font-bold mb-2">Активный заказ</h2>
                 <div class="space-y-2">
                    <p><strong>Откуда:</strong> <span id="active-ride-from"></span></p>
                    <p><strong>Куда:</strong> <span id="active-ride-to"></span></p>
                    <p><strong>Стоимость:</strong> <span id="active-ride-fare" class="font-bold"></span> руб.</p>
                </div>
                <div id="driver-action-buttons" class="mt-4 space-y-2"></div>
            </div>
            <h2 id="available-orders-title" class="text-xl font-bold mb-2">Доступные заказы</h2>
            <div id="orders-list" class="flex-grow overflow-y-auto space-y-3 pb-4">
                <div id="no-orders-placeholder" class="text-center py-10 text-gray-500">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto"></i>
                    <p class="mt-2">Нет доступных заказов</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://skoobtvzeojdmvjsexdm.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrb29idHZ6ZW9qZG12anNleGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTI5MjksImV4cCI6MjA3Mjc4ODkyOX0.3rtdGA9o07WUV8pKZctK4pA6VJyaUjn5MeZR-bigzP8';
            const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';

            // DOM Elements
            const globalLoader = document.getElementById('global-loader');
            const appContainer = document.getElementById('app-container');
            const loaderText = document.getElementById('loader-text');

            // App State
            let supabaseClient, currentUser, map;
            let fromCoords, toCoords;
            let rideUpdateChannel, locationChannel;
            let currentRideId = null;
            let driverLocationWatcherId = null;
            let driverMarker = null;

            async function main() {
                try {
                    console.log("App starting...");
                    const tg = window.Telegram?.WebApp;
                    if (!tg || !tg.initData) {
                        return showError("Ошибка: Приложение должно быть запущено внутри Telegram.", true);
                    }
                    tg.ready();
                    tg.expand();

                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    mapboxgl.accessToken = MAPBOX_TOKEN;
                    
                    loaderText.textContent = "Авторизация...";
                    const tgUser = tg.initDataUnsafe.user;
                    if (!tgUser) return showError("Не удалось получить данные пользователя Telegram.", true);

                    currentUser = await getOrCreateUser(tgUser);
                    if (!currentUser) return;

                    loaderText.textContent = "Получение геолокации...";
                    const userLocation = await getCurrentLocation();

                    initializeMap(userLocation);

                    if (currentUser.role === 'driver') {
                        await setupDriverScreen();
                    } else {
                        await setupPassengerScreen(userLocation);
                    }

                    globalLoader.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    lucide.createIcons();
                    console.log("App initialized successfully.");
                } catch (error) {
                    console.error("Критическая ошибка:", error);
                    showError(`Критическая ошибка: ${error.message}`, true);
                }
            }

            async function getOrCreateUser(tgUser) {
                try {
                    let { data, error } = await supabaseClient.from('user_profiles').select('*').eq('telegram_id', tgUser.id).single();
                    if (error && error.code !== 'PGRST116') throw error;
                    if (data) return data;

                    const fullName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim();
                    const { data: newUser, error: insertError } = await supabaseClient.from('user_profiles').insert({
                        id: crypto.randomUUID(), telegram_id: tgUser.id,
                        full_name: fullName || tgUser.username || `User ${tgUser.id}`, role: 'passenger'
                    }).select().single();
                    if (insertError) throw insertError;
                    return newUser;
                } catch (error) {
                    showError(`Ошибка авторизации: ${error.message}`);
                    return null;
                }
            }
            
            // --- Map & Geolocation ---
            function initializeMap(center) {
                map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/streets-v12', center: center, zoom: 14 });
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                map.addControl(new mapboxgl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true }), 'top-right');
            }

            function getCurrentLocation() {
                return new Promise((resolve) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve([pos.coords.longitude, pos.coords.latitude]),
                        () => resolve([37.6173, 55.7558]) // Fallback to Moscow
                    );
                });
            }

            async function geocode(coords) {
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${MAPBOX_TOKEN}`);
                const data = await response.json();
                return data.features[0]?.place_name || 'Текущее местоположение';
            }

            // --- Passenger Screen ---
            async function setupPassengerScreen(userLocation) {
                document.getElementById('passenger-screen').classList.remove('hidden');
                
                const createGeocoder = (containerId, placeholder) => {
                    const geocoder = new MapboxGeocoder({ accessToken: MAPBOX_TOKEN, mapboxgl: mapboxgl, marker: false, placeholder: placeholder });
                    document.getElementById(containerId).appendChild(geocoder.onAdd(map));
                    return geocoder;
                };

                const fromGeocoder = createGeocoder('from-geocoder', 'Откуда');
                const toGeocoder = createGeocoder('to-geocoder', 'Куда');
                
                const initialAddress = await geocode(userLocation);
                fromGeocoder.setInput(initialAddress);
                fromCoords = userLocation;

                fromGeocoder.on('result', (e) => fromCoords = e.result.geometry.coordinates);
                toGeocoder.on('result', (e) => toCoords = e.result.geometry.coordinates);

                document.getElementById('order-button').onclick = createRide;
                document.getElementById('cancel-search-button').onclick = cancelRide;
            }
            
            async function createRide() {
                if (!fromCoords || !toCoords) return window.Telegram.WebApp.showAlert("Пожалуйста, укажите оба адреса.");
                switchPassengerState('searching-state');
                try {
                    const { data: ride, error } = await supabaseClient.from('rides').insert({
                        passenger_id: currentUser.id,
                        pickup_location: document.querySelector('#from-geocoder input').value,
                        pickup_latitude: fromCoords[1], pickup_longitude: fromCoords[0],
                        destination_location: document.querySelector('#to-geocoder input').value,
                        destination_latitude: toCoords[1], destination_longitude: toCoords[0],
                        ride_status: 'requesting',
                        fare_amount: Math.floor(Math.random() * 701) + 300
                    }).select().single();
                    if (error) throw error;
                    currentRideId = ride.id;
                    subscribeToRideUpdates(ride.id);
                } catch (error) {
                    switchPassengerState('order-form-state');
                    window.Telegram.WebApp.showAlert(`Не удалось создать заказ: ${error.message}`);
                }
            }

            async function cancelRide() {
                if (!currentRideId) return;
                await supabaseClient.from('rides').update({ ride_status: 'cancelled' }).eq('id', currentRideId);
                cleanupAfterRide();
                switchPassengerState('order-form-state');
            }

            function subscribeToRideUpdates(rideId) {
                if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
                rideUpdateChannel = supabaseClient.channel(`ride-${rideId}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rides', filter: `id=eq.${rideId}`}, payload => updatePassengerRideStatus(payload.new))
                    .subscribe();
            }

            async function updatePassengerRideStatus(ride) {
                if (['accepted', 'enroute', 'in_progress'].includes(ride.ride_status)) {
                    switchPassengerState('driver-found-state');
                    const { data: driver } = await supabaseClient.from('user_profiles').select('full_name').eq('id', ride.driver_id).single();
                    const { data: vehicle } = await supabaseClient.from('vehicles').select('*').eq('driver_id', ride.driver_id).single();

                    document.getElementById('driver-name').textContent = driver?.full_name || 'Водитель';
                    document.getElementById('driver-car').textContent = vehicle ? `${vehicle.color} ${vehicle.brand} ${vehicle.model}` : 'Машина';
                    document.getElementById('driver-car-plate').textContent = vehicle?.plate_number || '...';
                    
                    listenForDriverLocation(ride.driver_id, ride.pickup_longitude, ride.pickup_latitude);
                }
                if (ride.ride_status === 'completed' || ride.ride_status === 'cancelled') {
                    cleanupAfterRide();
                    switchPassengerState('order-form-state');
                }
            }
            
            // --- Driver Screen ---
            async function setupDriverScreen() {
                document.getElementById('driver-screen').classList.remove('hidden');
                document.getElementById('map').classList.add('hidden');
                
                const { data: vehicle } = await supabaseClient.from('vehicles').select('id').eq('driver_id', currentUser.id).limit(1).single();
                const statusToggle = document.getElementById('driver-status-toggle');

                if (!vehicle) {
                    statusToggle.disabled = true;
                    document.getElementById('no-orders-placeholder').innerHTML = `<i data-lucide="car-front" class="w-12 h-12 mx-auto"></i><p class="mt-2">Зарегистрируйте автомобиль, чтобы принимать заказы.</p>`;
                    return;
                }

                statusToggle.addEventListener('change', (e) => {
                    const isOnline = e.target.checked;
                    document.getElementById('driver-status-text').textContent = isOnline ? 'На линии' : 'Офлайн';
                    document.getElementById('driver-status-text').classList.toggle('text-green-600', isOnline);
                    if (isOnline) {
                        subscribeToNewRides();
                        startSendingLocation();
                    } else {
                        if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
                        stopSendingLocation();
                        document.getElementById('orders-list').innerHTML = '';
                        document.getElementById('no-orders-placeholder').classList.remove('hidden');
                    }
                });
                await checkActiveRide();
            }

            function subscribeToNewRides() {
                renderAvailableRides();
                if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
                rideUpdateChannel = supabaseClient.channel('public:rides')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, () => { checkActiveRide(); renderAvailableRides(); })
                  .subscribe();
            }
            
            async function renderAvailableRides() { /* ... unchanged ... */ }
            async function acceptRide(event) { /* ... unchanged ... */ }
            async function checkActiveRide() { /* ... unchanged ... */ }
            function renderDriverActionButtons(ride) { /* ... unchanged ... */ }
            
            // --- Real-time Location Logic ---
            function startSendingLocation() {
                if (driverLocationWatcherId) return;
                locationChannel = supabaseClient.channel(`driver-${currentUser.id}`);
                locationChannel.subscribe();
                driverLocationWatcherId = navigator.geolocation.watchPosition((pos) => {
                    const { longitude, latitude } = pos.coords;
                    locationChannel.send({ type: 'broadcast', event: 'location_update', payload: { lon: longitude, lat: latitude }});
                }, (err) => console.error(err), { enableHighAccuracy: true });
            }

            function stopSendingLocation() {
                if (driverLocationWatcherId) navigator.geolocation.clearWatch(driverLocationWatcherId);
                if (locationChannel) locationChannel.unsubscribe();
                driverLocationWatcherId = null;
            }

            function listenForDriverLocation(driverId, passengerLon, passengerLat) {
                if (locationChannel) locationChannel.unsubscribe();
                locationChannel = supabaseClient.channel(`driver-${driverId}`)
                    .on('broadcast', { event: 'location_update' }, ({ payload }) => {
                        updateDriverMarkerOnMap(payload.lon, payload.lat, passengerLon, passengerLat);
                    }).subscribe();
            }
            
            function updateDriverMarkerOnMap(driverLon, driverLat, passengerLon, passengerLat) {
                const driverCoords = [driverLon, driverLat];
                if (!driverMarker) {
                    const el = document.createElement('div');
                    el.className = 'driver-marker';
                    driverMarker = new mapboxgl.Marker(el).setLngLat(driverCoords).addTo(map);
                } else {
                    driverMarker.setLngLat(driverCoords);
                }
                drawRoute(driverCoords, [passengerLon, passengerLat]);
                map.panTo(driverCoords);
            }
            
            async function drawRoute(start, end) {
                const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;
                const response = await fetch(url);
                const data = await response.json();
                const route = data.routes[0].geometry.coordinates;
                
                if (map.getSource('route')) {
                    map.getSource('route').setData({ type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: route }});
                } else {
                    map.addLayer({ id: 'route', type: 'line', source: { type: 'geojson', data: { type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: route }}}, layout: { 'line-join': 'round', 'line-cap': 'round' }, paint: { 'line-color': '#3b82f6', 'line-width': 6 }});
                }
            }

            // --- Utils & Cleanup ---
            function cleanupAfterRide() {
                if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
                if (locationChannel) locationChannel.unsubscribe();
                if (driverMarker) { driverMarker.remove(); driverMarker = null; }
                if (map.getSource('route')) { map.removeLayer('route'); map.removeSource('route'); }
                currentRideId = null;
            }
            
            function switchPassengerState(state) {
                ['order-form-state', 'searching-state', 'driver-found-state'].forEach(id => document.getElementById(id).classList.add('hidden'));
                const element = document.getElementById(state);
                if(element) element.classList.remove('hidden');
            }

            function showError(message, isCritical = false) {
                loaderText.innerHTML = `<span class="text-red-600 font-semibold text-center">${message}</span>`;
                if(isCritical) document.querySelector('#global-loader .loader').style.display = 'none';
            }
            
            // --- Unchanged Functions from previous version (for brevity) ---
            async function renderAvailableRides() { const { data: rides } = await supabaseClient.from('rides').select('*').eq('ride_status', 'requesting'); const list = document.getElementById('orders-list'); const p = document.getElementById('no-orders-placeholder'); list.innerHTML = ''; p.classList.toggle('hidden', rides.length > 0); rides.forEach(ride => list.insertAdjacentHTML('beforeend', `<div class="bg-gray-50 border p-4 rounded-lg"><div class="flex justify-between"><p class="font-semibold">${ride.pickup_location}</p><div class="text-lg font-bold text-blue-600">${ride.fare_amount} ₽</div></div><p class="text-sm text-gray-500">${ride.destination_location}</p><button data-ride-id="${ride.id}" class="accept-ride-btn mt-4 w-full bg-green-500 text-white font-bold py-2 rounded-lg">Принять</button></div>`)); document.querySelectorAll('.accept-ride-btn').forEach(b => b.onclick = acceptRide); }
            async function acceptRide(event) { event.target.disabled = true; event.target.textContent = '...'; const { error } = await supabaseClient.from('rides').update({ driver_id: currentUser.id, ride_status: 'accepted' }).eq('id', event.target.dataset.rideId).eq('ride_status', 'requesting'); if (error) window.Telegram.WebApp.showAlert('Не удалось принять заказ.'); }
            async function checkActiveRide() { const { data: ride } = await supabaseClient.from('rides').select('*').eq('driver_id', currentUser.id).in('ride_status', ['accepted', 'enroute', 'in_progress']).maybeSingle(); const isActive = !!ride; document.getElementById('available-orders-title').classList.toggle('hidden', isActive); document.getElementById('orders-list').classList.toggle('hidden', isActive); document.getElementById('active-ride-driver').classList.toggle('hidden', !isActive); if (isActive) { document.getElementById('active-ride-from').textContent = ride.pickup_location; document.getElementById('active-ride-to').textContent = ride.destination_location; document.getElementById('active-ride-fare').textContent = ride.fare_amount; renderDriverActionButtons(ride); } }
            function renderDriverActionButtons(ride) { const c = document.getElementById('driver-action-buttons'); c.innerHTML = ''; const u = (s) => supabaseClient.from('rides').update({ ride_status: s }).eq('id', ride.id); const a = { 'accepted': { t: 'Я на месте', f: () => u('enroute'), c: 'bg-blue-500' }, 'enroute': { t: 'Начать поездку', f: () => u('in_progress'), c: 'bg-blue-500' }, 'in_progress': { t: 'Завершить поездку', f: () => u('completed'), c: 'bg-green-500' } }; if (a[ride.ride_status]) { const { t, f, c: btnClass } = a[ride.ride_status]; c.innerHTML = `<button class="w-full text-white font-bold py-2 rounded-lg ${btnClass}">${t}</button>`; c.firstChild.onclick = f; } c.innerHTML += `<button class="w-full bg-red-500 text-white font-bold py-2 rounded-lg mt-2">Отменить</button>`; c.lastChild.onclick = () => u('cancelled'); }

            main();
        });
    </script>
</body>
</html>

