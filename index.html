<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Такси Mini App</title>
    
    <!-- Подключение стилей и скриптов -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body, html { overscroll-behavior: none; overflow: hidden; height: 100%; width: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .bottom-sheet { touch-action: none; transition: transform 0.3s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .driver-marker { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="%233B82F6" stroke="white" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>'); background-size: contain; width: 40px; height: 40px; }
        .mapboxgl-ctrl-geocoder { width: 100% !important; max-width: none !important; box-shadow: none; }
        .mapboxgl-ctrl-geocoder--input { height: 48px !important; padding-left: 40px !important; background-color: #f3f4f6; border-radius: 0.5rem; border: transparent; }
        .mapboxgl-ctrl-geocoder--icon { top: 12px !important; left: 12px !important; }
        .custom-marker { display: flex; align-items: center; justify-content: center; background-color: #3b82f6; color: white; width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; font-weight: bold; }
        .screen { position: absolute; inset: 0; z-index: 30; background-color: #f9fafb; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .screen.active { transform: translateX(0); }
    </style>
</head>
<body class="bg-gray-100">

    <div id="global-loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50 p-4">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-gray-600">Подключаемся...</p>
    </div>

    <div id="app-container" class="relative h-screen w-screen hidden">
        <!-- КАРТА ВСЕГДА НА ФОНЕ -->
        <div id="map" class="absolute inset-0 z-0"></div>

        <!-- Интерфейс Пассажира (поверх карты) -->
        <div id="passenger-ui" class="hidden z-10">
            <div id="bottom-sheet" class="bottom-sheet absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl p-4 flex flex-col" style="transform: translateY(calc(100% - 300px));">
                <div id="sheet-handle" class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4 cursor-grab"></div>
                <div id="sheet-content">
                    <div id="order-form-state"><h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Куда поедем?</h2><div class="space-y-3"><div id="from-geocoder"></div><div id="to-geocoder"></div></div><button id="order-button" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-lg mt-5 transition-all disabled:bg-gray-400">Выберите адрес</button></div>
                    <div id="searching-state" class="hidden text-center py-8"><div class="loader mx-auto"></div><h3 class="text-xl font-semibold mt-4">Ищем машину...</h3><button id="cancel-search-button" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-lg mt-6">Отменить поиск</button></div>
                    <div id="driver-found-state" class="hidden"><h2 id="ride-title" class="text-2xl font-bold text-gray-800 text-center mb-2">Водитель в пути!</h2><div class="bg-gray-100 p-3 rounded-lg flex items-center space-x-4"><img id="driver-avatar" src="https://placehold.co/60x60/E2E8F0/A0AEC0?text=A" class="w-14 h-14 rounded-full"><div><p id="driver-name" class="font-bold text-lg">Водитель</p><p id="driver-car" class="text-gray-600">Машина</p></div><div class="flex-grow text-right"><p id="driver-car-plate" class="font-mono bg-white border border-gray-300 px-2 py-1 rounded">A123BC</p></div></div><div class="mt-4 text-center"><p id="ride-status-passenger" class="text-lg font-medium text-blue-600">Водитель едет к вам</p></div></div>
                </div>
            </div>
        </div>

        <!-- Интерфейс Водителя (поверх карты) -->
        <div id="driver-ui" class="hidden z-20 h-full w-full flex flex-col pointer-events-none">
            <div class="bg-white p-4 flex justify-between items-center border-b pointer-events-auto">
                <h1 class="text-2xl font-bold">Заказы</h1>
                <div class="flex items-center space-x-4">
                    <button id="profile-button"><i data-lucide="user-cog" class="w-6 h-6 text-gray-600"></i></button>
                    <div class="flex items-center space-x-2">
                        <span id="driver-status-text" class="text-gray-600 font-medium">Офлайн</span>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="driver-status-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                    </div>
                </div>
            </div>
            <!-- Панель активного заказа -->
            <div id="active-ride-panel" class="hidden p-4 bg-white border-b pointer-events-auto">
                <h2 class="text-xl font-bold mb-2">Активный заказ</h2>
                <div class="space-y-2 text-sm"><p><strong>Откуда:</strong> <span id="active-ride-from"></span></p><p><strong>Куда:</strong> <span id="active-ride-to"></span></p><p><strong>Стоимость:</strong> <span id="active-ride-fare" class="font-bold"></span> руб.</p></div>
                <div id="driver-action-buttons" class="mt-4 space-y-2"></div>
            </div>
             <!-- Панель со списком заказов -->
            <div id="orders-panel" class="flex-grow flex flex-col bg-white pointer-events-auto">
                <h2 class="text-xl font-bold px-4 pt-4">Доступные заказы</h2>
                <div id="orders-list" class="flex-grow overflow-y-auto space-y-3 p-4">
                    <div id="no-orders-placeholder" class="text-center py-10 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto"></i><p class="mt-2">Нет доступных заказов</p></div>
                </div>
            </div>
        </div>
        
        <!-- Экран Профиля Водителя (выезжающий) -->
        <div id="driver-profile-screen" class="screen">
            <div class="bg-white p-4 flex items-center border-b"><button id="back-to-orders-button"><i data-lucide="arrow-left" class="w-6 h-6"></i></button><h1 class="text-2xl font-bold text-center flex-grow mr-6">Мой автомобиль</h1></div>
            <div class="flex-grow overflow-y-auto p-4 space-y-4">
                <div><label class="font-medium text-gray-700">Марка</label><input id="car-brand" type="text" placeholder="Например, Lada" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="font-medium text-gray-700">Модель</label><input id="car-model" type="text" placeholder="Например, Vesta" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="font-medium text-gray-700">Год выпуска</label><input id="car-year" type="number" placeholder="2023" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="font-medium text-gray-700">Цвет</label><input id="car-color" type="text" placeholder="Белый" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="font-medium text-gray-700">Гос. номер</label><input id="car-plate" type="text" placeholder="А123БВ 777" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="font-medium text-gray-700">Класс</label><select id="car-class" class="w-full mt-1 p-2 bg-gray-100 rounded border focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="economy">Эконом</option><option value="comfort">Комфорт</option><option value="business">Бизнес</option></select></div>
            </div>
            <div class="p-4 border-t bg-white"><button id="save-vehicle-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700">Сохранить</button></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Константы и конфигурация ---
    const SUPABASE_URL = 'https://skoobtvzeojdmvjsexdm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrb29idHZ6ZW9qZG12anNleGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTI5MjksImV4cCI6MjA3Mjc4ODkyOX0.3rtdGA9o07WUV8pKZctK4pA6VJyaUjn5MeZR-bigzP8';
    const MAPBOX_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
    const FARE_CONFIG = { base: 150, perKm: 25, perMin: 10 };

    // --- Глобальное состояние приложения ---
    let supabaseClient, tg, map, currentUser;
    let fromCoords, toCoords, fromAddress, toAddress;
    let fromMarker, toMarker, driverMarker;
    let rideUpdateChannel, locationChannel, driverLocationWatcherId;
    let currentRideId = null;
    let driverCurrentLocation = null;
    let driverHasVehicle = false;

    // --- Основная функция инициализации ---
    async function main() {
        try {
            console.log("Приложение запускается...");
            tg = window.Telegram?.WebApp;
            if (!tg || !tg.initData) return showError("Пожалуйста, запустите приложение внутри Telegram.", true);
            tg.ready(); tg.expand();

            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            showLoader("Авторизация...");
            const tgUser = tg.initDataUnsafe.user;
            if (!tgUser) return showError("Не удалось получить данные пользователя Telegram.", true);
            currentUser = await getOrCreateUser(tgUser);
            if (!currentUser) return;

            showLoader("Загрузка карты...");
            const userLocation = await getCurrentLocation();
            initializeMap(userLocation); // Карта инициализируется один раз для всех

            if (currentUser.role === 'driver') {
                await setupDriverScreen();
            } else {
                await setupPassengerScreen();
            }

            hideLoader();
            lucide.createIcons();
            console.log("Приложение успешно инициализировано.");
        } catch (error) {
            console.error("Критическая ошибка при инициализации:", error);
            showError(`Критическая ошибка: ${error.message}`, true);
        }
    }

    // --- Пользователь и Авторизация ---
    async function getOrCreateUser(tgUser) {
        try {
            let { data, error } = await supabaseClient.from('user_profiles').select('*').eq('telegram_id', tgUser.id).single();
            if (error && error.code !== 'PGRST116') throw error;
            if (data) return data;
            const fullName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim();
            const { data: newUser, error: insertError } = await supabaseClient.from('user_profiles').insert({ 
                id: crypto.randomUUID(), telegram_id: tgUser.id, 
                full_name: fullName || tgUser.username || `User ${tgUser.id}`, role: 'passenger' 
            }).select().single();
            if (insertError) throw insertError;
            return newUser;
        } catch (error) {
            console.error("Ошибка в getOrCreateUser:", error);
            showError(`Ошибка авторизации: ${error.message}`);
            return null;
        }
    }

    // --- Карта и Геолокация ---
    function initializeMap(center) {
        map = new mapboxgl.Map({ 
            container: 'map', style: 'mapbox://styles/mapbox/streets-v12', 
            center: center, zoom: 14 
        });
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.GeolocateControl({ trackUserLocation: true }), 'top-right');
    }

    function getCurrentLocation() {
        return new Promise((resolve) => {
            const fallback = () => resolve([37.6173, 55.7558]);
            const success = (pos) => resolve([pos.coords.longitude, pos.coords.latitude]);
            const error = (err) => { console.warn(`Ошибка геолокации: ${err.message}`); fallback(); };
            const watchId = setTimeout(fallback, 10000);
            navigator.geolocation.getCurrentPosition(
                (pos) => { clearTimeout(watchId); success(pos); }, error, 
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        });
    }

    // --- Интерфейс и логика Пассажира ---
    async function setupPassengerScreen() {
        document.getElementById('passenger-ui').classList.remove('hidden');
        const orderButton = document.getElementById('order-button');
        orderButton.disabled = true;

        const geocoderOptions = (placeholder) => ({ accessToken: MAPBOX_TOKEN, mapboxgl: mapboxgl, marker: false, placeholder: placeholder, proximity: 'ip' });
        const fromGeocoder = new MapboxGeocoder(geocoderOptions('Откуда'));
        document.getElementById('from-geocoder').appendChild(fromGeocoder.onAdd(map));
        const toGeocoder = new MapboxGeocoder(geocoderOptions('Куда'));
        document.getElementById('to-geocoder').appendChild(toGeocoder.onAdd(map));

        // Устанавливаем начальный адрес на основе геолокации, которая уже есть
        fromCoords = map.getCenter().toArray();
        fromAddress = await geocodeReverse(fromCoords);
        fromGeocoder.setInput(fromAddress || '');
        updateMapMarkers();

        fromGeocoder.on('result', (e) => { fromCoords = e.result.geometry.coordinates; fromAddress = e.result.place_name; updateMapMarkers(); calculateAndDisplayFare(); });
        toGeocoder.on('result', (e) => { toCoords = e.result.geometry.coordinates; toAddress = e.result.place_name; updateMapMarkers(); calculateAndDisplayFare(); });
        
        orderButton.onclick = createRide;
        document.getElementById('cancel-search-button').onclick = cancelRide;
    }
    
    // --- Интерфейс и логика Водителя ---
    async function setupDriverScreen() {
        document.getElementById('driver-ui').classList.remove('hidden');
        await checkDriverVehicle();

        document.getElementById('profile-button').onclick = () => document.getElementById('driver-profile-screen').classList.add('active');
        document.getElementById('back-to-orders-button').onclick = () => document.getElementById('driver-profile-screen').classList.remove('active');
        document.getElementById('save-vehicle-button').onclick = saveVehicleData;
        
        const statusToggle = document.getElementById('driver-status-toggle');
        statusToggle.addEventListener('change', async (e) => {
            const isOnline = e.target.checked;
            if (isOnline && !driverHasVehicle) {
                tg.showAlert("Пожалуйста, добавьте информацию о вашем автомобиле в профиле, чтобы выйти на линию.");
                e.target.checked = false;
                return;
            }

            document.getElementById('driver-status-text').classList.toggle('text-green-600', isOnline);
            document.getElementById('driver-status-text').textContent = isOnline ? 'На линии' : 'Офлайн';

            if (isOnline) {
                showLoader('Получение геолокации...');
                driverCurrentLocation = await getCurrentLocation();
                hideLoader();
                subscribeToNewRides();
                startSendingLocation();
            } else {
                if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
                stopSendingLocation();
                document.getElementById('orders-list').innerHTML = '';
                document.getElementById('no-orders-placeholder').classList.remove('hidden');
            }
        });
        await checkActiveRide();
    }
    
    async function checkDriverVehicle() {
        const { data } = await supabaseClient.from('vehicles').select('id').eq('driver_id', currentUser.id).limit(1).single();
        driverHasVehicle = !!data;
        const placeholder = document.getElementById('no-orders-placeholder');
        if (!driverHasVehicle) {
            placeholder.innerHTML = `<i data-lucide="car-front" class="w-12 h-12 mx-auto"></i><p class="mt-2">Добавьте автомобиль в профиле.</p>`;
        } else {
             placeholder.innerHTML = `<i data-lucide="inbox" class="w-12 h-12 mx-auto"></i><p class="mt-2">Нет доступных заказов</p>`;
        }
        lucide.createIcons();
    }

    async function showProfileScreen() {
        document.getElementById('driver-profile-screen').classList.add('active');
        const { data } = await supabaseClient.from('vehicles').select('*').eq('driver_id', currentUser.id).single();
        if (data) {
            document.getElementById('car-brand').value = data.brand || '';
            document.getElementById('car-model').value = data.model || '';
            document.getElementById('car-year').value = data.year || '';
            document.getElementById('car-color').value = data.color || '';
            document.getElementById('car-plate').value = data.plate_number || '';
            document.getElementById('car-class').value = data.class || 'economy';
        }
    }
    
    async function saveVehicleData() {
        const button = document.getElementById('save-vehicle-button');
        button.disabled = true; button.textContent = "Сохранение...";
        const vehicleData = {
            driver_id: currentUser.id, brand: document.getElementById('car-brand').value,
            model: document.getElementById('car-model').value, year: document.getElementById('car-year').value,
            color: document.getElementById('car-color').value, plate_number: document.getElementById('car-plate').value,
            class: document.getElementById('car-class').value,
        };
        if (!vehicleData.brand || !vehicleData.model || !vehicleData.plate_number) {
            tg.showAlert("Пожалуйста, заполните как минимум Марку, Модель и Гос. номер.");
            button.disabled = false; button.textContent = "Сохранить"; return;
        }
        const { error } = await supabaseClient.from('vehicles').upsert(vehicleData, { onConflict: 'driver_id' });
        if (error) {
            tg.showAlert(`Ошибка сохранения: ${error.message}`);
        } else {
            tg.showPopup({ title: "Успешно!", message: "Данные об автомобиле сохранены." });
            await checkDriverVehicle();
            document.getElementById('driver-profile-screen').classList.remove('active');
        }
        button.disabled = false; button.textContent = "Сохранить";
    }

    async function calculateAndDisplayFare() {
        const orderButton = document.getElementById('order-button');
        if (!fromCoords || !toCoords) { orderButton.disabled = true; orderButton.textContent = 'Выберите адрес'; return; }
        orderButton.disabled = true; orderButton.textContent = 'Расчет...';
        const data = await getDirections(fromCoords, toCoords);
        if (!data || !data.routes || data.routes.length === 0) { orderButton.textContent = 'Маршрут не найден'; return; }
        const route = data.routes[0];
        const fare = FARE_CONFIG.base + ((route.distance / 1000) * FARE_CONFIG.perKm) + ((route.duration / 60) * FARE_CONFIG.perMin);
        const roundedFare = Math.ceil(fare / 10) * 10;
        orderButton.textContent = `Заказать за ~${roundedFare} ₽`;
        orderButton.dataset.fare = roundedFare;
        orderButton.disabled = false;
    }

    async function createRide() {
        switchPassengerState('searching-state');
        try {
            const { data: ride, error } = await supabaseClient.from('rides').insert({ 
                passenger_id: currentUser.id, pickup_location: fromAddress, destination_location: toAddress, 
                pickup_latitude: fromCoords[1], pickup_longitude: fromCoords[0], 
                destination_latitude: toCoords[1], destination_longitude: toCoords[0], 
                fare_amount: document.getElementById('order-button').dataset.fare 
            }).select().single();
            if (error) throw error;
            currentRideId = ride.id;
            subscribeToRideUpdates(ride.id);
        } catch (error) {
            switchPassengerState('order-form-state');
            tg.showAlert(`Не удалось создать заказ: ${error.message}`);
        }
    }

    async function cancelRide() {
        if (!currentRideId) return;
        await supabaseClient.from('rides').update({ ride_status: 'cancelled' }).eq('id', currentRideId);
        cleanupAfterRide();
        switchPassengerState('order-form-state');
    }
    
    function subscribeToNewRides() {
        renderAvailableRides();
        if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
        rideUpdateChannel = supabaseClient.channel('public:rides')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, (payload) => {
              renderAvailableRides();
              checkActiveRide();
          })
          .subscribe((status) => {
              if (status === 'SUBSCRIBED') console.log('Успешно подписан на заказы!');
          });
    }

    async function renderAvailableRides() {
        if (!driverHasVehicle) return;
        const { data: rides, error } = await supabaseClient.from('rides').select('*').eq('ride_status', 'requesting');
        if (error) { console.error("Ошибка загрузки заказов:", error); return; }
        const list = document.getElementById('orders-list');
        const placeholder = document.getElementById('no-orders-placeholder');
        list.innerHTML = '';
        placeholder.classList.toggle('hidden', rides.length > 0);
        for (const ride of rides) {
            let distanceToClient = '';
            if (driverCurrentLocation) {
                const directions = await getDirections(driverCurrentLocation, [ride.pickup_longitude, ride.pickup_latitude]);
                if (directions && directions.routes && directions.routes.length > 0) {
                    distanceToClient = `<p class="text-sm font-semibold text-blue-600 mt-1">До клиента: ${(directions.routes[0].distance / 1000).toFixed(1)} км</p>`;
                }
            }
            list.insertAdjacentHTML('beforeend', `<div class="bg-gray-50 border p-4 rounded-lg"><div class="flex justify-between items-start"><div class="pr-2"><p class="font-semibold">${ride.pickup_location}</p><p class="text-sm text-gray-500">${ride.destination_location}</p>${distanceToClient}</div><div class="text-lg font-bold text-blue-600 pl-2 whitespace-nowrap">${ride.fare_amount} ₽</div></div><button data-ride-id="${ride.id}" class="accept-ride-btn mt-3 w-full bg-green-500 text-white font-bold py-2 rounded-lg">Принять</button></div>`);
        }
        document.querySelectorAll('.accept-ride-btn').forEach(b => b.onclick = acceptRide);
    }
    
    async function acceptRide(event) {
        event.target.disabled = true; event.target.textContent = 'Принимаю...';
        const rideId = event.target.dataset.rideId;
        const { error } = await supabaseClient.from('rides').update({ driver_id: currentUser.id, ride_status: 'accepted' }).eq('id', rideId).eq('ride_status', 'requesting');
        if (error) { tg.showAlert('Не удалось принять заказ. Возможно, его уже забрали.'); event.target.disabled = false; event.target.textContent = 'Принять'; }
    }
    
    async function checkActiveRide() {
        const { data: ride } = await supabaseClient.from('rides').select('*').eq('driver_id', currentUser.id).in('ride_status', ['accepted', 'enroute', 'in_progress']).maybeSingle();
        const isActive = !!ride;
        
        document.getElementById('orders-panel').classList.toggle('hidden', isActive);
        document.getElementById('active-ride-panel').classList.toggle('hidden', !isActive);

        if (isActive) {
            document.getElementById('active-ride-from').textContent = ride.pickup_location;
            document.getElementById('active-ride-to').textContent = ride.destination_location;
            document.getElementById('active-ride-fare').textContent = ride.fare_amount;
            renderDriverActionButtons(ride);
            const passengerCoords = [ride.pickup_longitude, ride.pickup_latitude];
            const destinationCoords = [ride.destination_longitude, ride.destination_latitude];
            if ((ride.ride_status === 'accepted' || ride.ride_status === 'enroute') && driverCurrentLocation) {
                drawTripRoute(driverCurrentLocation, passengerCoords, 'driver-route');
            } else if (ride.ride_status === 'in_progress') {
                drawTripRoute(driverCurrentLocation || passengerCoords, destinationCoords, 'driver-route');
            }
        }
    }
    
    function renderDriverActionButtons(ride) {
        const container = document.getElementById('driver-action-buttons');
        container.innerHTML = '';
        const updateStatus = async (newStatus) => {
            await supabaseClient.from('rides').update({ ride_status: newStatus }).eq('id', ride.id);
            if(newStatus === 'completed' || newStatus === 'cancelled') {
                checkActiveRide(); 
            }
        };
        const actions = { 'accepted': { text: 'Я на месте', action: () => updateStatus('enroute'), class: 'bg-blue-500' }, 'enroute': { text: 'Начать поездку', action: () => updateStatus('in_progress'), class: 'bg-blue-500' }, 'in_progress': { text: 'Завершить поездку', action: () => updateStatus('completed'), class: 'bg-green-500' } };
        if (actions[ride.ride_status]) {
            const { text, action, 'class': btnClass } = actions[ride.ride_status];
            container.innerHTML = `<button class="w-full text-white font-bold py-2 rounded-lg ${btnClass}">${text}</button>`;
            container.firstChild.onclick = action;
        }
        container.innerHTML += `<button class="w-full bg-red-500 text-white font-bold py-2 rounded-lg mt-2">Отменить</button>`;
        container.lastChild.onclick = () => updateStatus('cancelled');
    }

    async function updatePassengerRideStatus(ride) {
        if (currentUser.role !== 'passenger') return;
        const statusMap = { 'accepted': 'Водитель принял заказ', 'enroute': 'Водитель скоро будет на месте', 'in_progress': 'В пути к месту назначения' };
        if (statusMap[ride.ride_status]) {
            switchPassengerState('driver-found-state');
            document.getElementById('ride-status-passenger').textContent = statusMap[ride.ride_status];
            const { data: driver } = await supabaseClient.from('user_profiles').select('full_name').eq('id', ride.driver_id).single();
            const { data: vehicle } = await supabaseClient.from('vehicles').select('*').eq('driver_id', ride.driver_id).single();
            document.getElementById('driver-name').textContent = driver?.full_name || 'Водитель';
            document.getElementById('driver-car').textContent = vehicle ? `${vehicle.color} ${vehicle.brand} ${vehicle.model}` : 'Машина';
            document.getElementById('driver-car-plate').textContent = vehicle?.plate_number || '...';
            listenForDriverLocation(ride.driver_id, [ride.pickup_longitude, ride.pickup_latitude]);
        }
        if (ride.ride_status === 'completed' || ride.ride_status === 'cancelled') {
            tg.showPopup({ title: ride.ride_status === 'completed' ? 'Поездка завершена!' : 'Заказ отменен', message: ride.ride_status === 'completed' ? 'Спасибо!' : 'Надеемся увидеть вас снова.', buttons: [{ type: 'ok' }] });
            cleanupAfterRide();
            switchPassengerState('order-form-state');
        }
    }

    function startSendingLocation() {
        if (driverLocationWatcherId) return;
        locationChannel = supabaseClient.channel(`driver-${currentUser.id}`);
        locationChannel.subscribe();
        driverLocationWatcherId = navigator.geolocation.watchPosition(
            (pos) => {
                driverCurrentLocation = [pos.coords.longitude, pos.coords.latitude];
                locationChannel.send({ type: 'broadcast', event: 'location_update', payload: { lon: pos.coords.longitude, lat: pos.coords.latitude } });
            }, 
            console.error, { enableHighAccuracy: true }
        );
    }

    function stopSendingLocation() {
        if (driverLocationWatcherId) { navigator.geolocation.clearWatch(driverLocationWatcherId); driverLocationWatcherId = null; }
        if (locationChannel) { locationChannel.unsubscribe(); locationChannel = null; }
        driverCurrentLocation = null;
    }

    function listenForDriverLocation(driverId, destination) {
        if (locationChannel) locationChannel.unsubscribe();
        locationChannel = supabaseClient.channel(`driver-${driverId}`)
            .on('broadcast', { event: 'location_update' }, ({ payload }) => {
                const driverCoords = [payload.lon, payload.lat];
                if (!driverMarker) driverMarker = createMarker('', driverCoords, true).addTo(map);
                else driverMarker.setLngLat(driverCoords);
                drawTripRoute(driverCoords, destination, 'driver-route');
            }).subscribe();
    }

    function updateMapMarkers() {
        if (fromMarker) fromMarker.remove();
        if (toMarker) toMarker.remove();
        if (fromCoords) fromMarker = createMarker('A', fromCoords).addTo(map);
        if (toCoords) toMarker = createMarker('Б', toCoords).addTo(map);
        if (fromCoords && toCoords) {
            const bounds = new mapboxgl.LngLatBounds();
            bounds.extend(fromCoords);
            bounds.extend(toCoords);
            map.fitBounds(bounds, { padding: 80 });
            drawTripRoute(fromCoords, toCoords, 'trip-preview');
        }
    }
    
    async function drawTripRoute(start, end, routeId) {
        const data = await getDirections(start, end);
        if (!data || !data.routes || !data.routes.length) return;
        const route = data.routes[0].geometry;
        if (map.getSource(routeId)) { map.getSource(routeId).setData(route); } 
        else { map.addLayer({ id: routeId, type: 'line', source: { type: 'geojson', data: route }, paint: { 'line-color': '#3b82f6', 'line-width': 6, 'line-opacity': 0.8 } }); }
    }
    
    async function geocodeReverse(coords) {
        try {
            const r = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${MAPBOX_TOKEN}`);
            const d = await r.json();
            return (d && d.features && d.features.length > 0) ? d.features[0].place_name : "Неизвестный адрес";
        } catch (e) { console.error("Ошибка обратного геокодирования:", e); return "Ошибка определения адреса"; }
    }
    
    async function getDirections(start, end) {
        try {
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            const response = await fetch(url);
            return response.ok ? await response.json() : null;
        } catch (e) { console.error("Ошибка API маршрутов:", e); return null; }
    }
    
    function showLoader(text) { document.getElementById('loader-text').textContent = text; document.getElementById('global-loader').classList.remove('hidden'); }
    function hideLoader() { document.getElementById('global-loader').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); }
    function showError(message, isCritical = false) { const loader = document.getElementById('global-loader'); loader.classList.remove('hidden'); document.getElementById('loader-text').innerHTML = `<span class="text-red-600 font-semibold text-center">${message}</span>`; if(isCritical) loader.querySelector('.loader').style.display = 'none'; }
    function showScreen(screenId) { document.querySelectorAll('.screen, #passenger-ui').forEach(s => s.classList.add('hidden')); document.getElementById(screenId)?.classList.remove('hidden'); }
    function switchPassengerState(state) { ['order-form-state', 'searching-state', 'driver-found-state'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(state)?.classList.remove('hidden'); }
    function cleanupAfterRide() {
        if (rideUpdateChannel) rideUpdateChannel.unsubscribe();
        if (locationChannel) locationChannel.unsubscribe();
        if (driverMarker) { driverMarker.remove(); driverMarker = null; }
        if (fromMarker) { fromMarker.remove(); fromMarker = null; }
        if (toMarker) { toMarker.remove(); toMarker = null; }
        ['trip-preview', 'driver-route'].forEach(id => { if (map.getLayer(id)) map.removeLayer(id); if (map.getSource(id)) map.removeSource(id); });
        currentRideId = null;
    }
    function createMarker(text, coords, isDriver = false) { const el = document.createElement('div'); el.className = isDriver ? 'driver-marker' : 'custom-marker'; if (!isDriver) el.textContent = text; return new mapboxgl.Marker(el).setLngLat(coords); }
    
    main();
});
</script>
</body>
</html>

